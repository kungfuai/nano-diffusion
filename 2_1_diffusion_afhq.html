<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Training a Diffusion Model for Animal Face Images – Nano Diffusion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./2_1_a_move_off_notebook.html" rel="next">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Nano Diffusion</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/kungfuai/nano-diffusion.git" title="GitHub" class="quarto-navigation-tool px-1" aria-label="GitHub"><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./2_1_diffusion_afhq.html">Generating Animal Face Images</a></li><li class="breadcrumb-item"><a href="./2_1_diffusion_afhq.html">Training a Diffusion Model for Animal Face Images</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visual_story.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Visual Story of Diffusion and Flow matching</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Generating a 2D Point Cloud</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Diffusion</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1_1_Diffusion 2D Toy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Training a Diffusion Model on 2D Points</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1_1_a_refactor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A refactoring exercise</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1_1_b_Diffusion_2D_hyperparams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Our First Pareto Frontier Plot</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Flow Matching</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1_2_Flow Matching 2D Toy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Training a Flow Matching Model for 2D Point Generation</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Generating Animal Face Images</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2_1_diffusion_afhq.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Training a Diffusion Model for Animal Face Images</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2_1_a_move_off_notebook.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time to move off of the notebook</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2_2_fid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quality evaluation of an image generation model</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Text Conditioning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4_1_text_conditioning_ddpm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Conditioning (text2image)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4_1a_generate_t2i_ddpm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generate images with text conditioning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Image Captioning Lesson.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generating an Image Captions Dataset</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4_2_text_conditioning_cfm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text conditioning for Flow Matching</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4_2a_generate_t2i_cfm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generate images with text prompts using flow matching</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Scaling up: generate bigger and more diverse images</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5_1_vae_and_latent_space.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scaling up</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5_2_mj_latents.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Training a Diffusion Model on Latent Representations</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Additional resources</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./slurm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Managing training jobs with SLURM</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#running-this-notebook-in-the-background" id="toc-running-this-notebook-in-the-background" class="nav-link" data-scroll-target="#running-this-notebook-in-the-background">Running this notebook in the background</a></li>
  </ul></li>
  <li><a href="#training-configuration" id="toc-training-configuration" class="nav-link" data-scroll-target="#training-configuration">Training Configuration</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data">Load data</a></li>
  <li><a href="#create-model-components-for-diffusion" id="toc-create-model-components-for-diffusion" class="nav-link" data-scroll-target="#create-model-components-for-diffusion">Create model components for diffusion</a>
  <ul class="collapse">
  <li><a href="#library-code-for-model-architecture" id="toc-library-code-for-model-architecture" class="nav-link" data-scroll-target="#library-code-for-model-architecture">Library code for model architecture</a></li>
  <li><a href="#create-model-the-user-logic" id="toc-create-model-the-user-logic" class="nav-link" data-scroll-target="#create-model-the-user-logic">Create model (the user logic)</a></li>
  <li><a href="#optimizer" id="toc-optimizer" class="nav-link" data-scroll-target="#optimizer">Optimizer</a></li>
  </ul></li>
  <li><a href="#train" id="toc-train" class="nav-link" data-scroll-target="#train">Train</a>
  <ul class="collapse">
  <li><a href="#forward-diffusion" id="toc-forward-diffusion" class="nav-link" data-scroll-target="#forward-diffusion">Forward diffusion</a></li>
  <li><a href="#visualizing-forward-diffusion-on-an-image" id="toc-visualizing-forward-diffusion-on-an-image" class="nav-link" data-scroll-target="#visualizing-forward-diffusion-on-an-image">Visualizing forward diffusion on an image</a></li>
  </ul></li>
  <li><a href="#training-loop" id="toc-training-loop" class="nav-link" data-scroll-target="#training-loop">Training loop</a></li>
  <li><a href="#generate" id="toc-generate" class="nav-link" data-scroll-target="#generate">Generate</a>
  <ul class="collapse">
  <li><a href="#the-sampling-algorithm-reversing-the-diffusion-process" id="toc-the-sampling-algorithm-reversing-the-diffusion-process" class="nav-link" data-scroll-target="#the-sampling-algorithm-reversing-the-diffusion-process">The sampling algorithm: reversing the diffusion process</a></li>
  <li><a href="#visualize-sampled-images" id="toc-visualize-sampled-images" class="nav-link" data-scroll-target="#visualize-sampled-images">Visualize sampled images</a></li>
  <li><a href="#train-some-more" id="toc-train-some-more" class="nav-link" data-scroll-target="#train-some-more">Train some more</a></li>
  <li><a href="#train-even-more" id="toc-train-even-more" class="nav-link" data-scroll-target="#train-even-more">Train even more</a></li>
  <li><a href="#and-some-more" id="toc-and-some-more" class="nav-link" data-scroll-target="#and-some-more">And, some more</a></li>
  <li><a href="#quantitative-evaluation-of-image-quality" id="toc-quantitative-evaluation-of-image-quality" class="nav-link" data-scroll-target="#quantitative-evaluation-of-image-quality">Quantitative Evaluation of Image Quality</a></li>
  </ul></li>
  <li><a href="#questions-for-futher-exploration" id="toc-questions-for-futher-exploration" class="nav-link" data-scroll-target="#questions-for-futher-exploration">Questions for Futher Exploration</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./2_1_diffusion_afhq.html">Generating Animal Face Images</a></li><li class="breadcrumb-item"><a href="./2_1_diffusion_afhq.html">Training a Diffusion Model for Animal Face Images</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Training a Diffusion Model for Animal Face Images</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><a href="https://colab.research.google.com/github/kungfuai/nano-diffusion/blob/quarto/notebooks/2_1_diffusion_afhq.ipynb">open in colab</a></p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This notebook demonstrates how to train a diffusion model on the Animal Faces-HQ (AFHQ) dataset. We’ll implement a simplified version of denoising diffusion probabilistic models (DDPM) to generate high-quality animal face images.</p>
<p>The training algorithm and generation (sampling) algorithm are the same as the <a href="./1_1_Diffusion 2D Toy.html">2D toy example</a>. The main difference is the model architecture that needs to accepts image as an input, and generates image as the output.</p>
<section id="overview" class="level3">
<h3 class="anchored" data-anchor-id="overview">Overview</h3>
<p>Here is an overview of the tutorial:</p>
<ol type="1">
<li>Set up the training configuration</li>
<li>Load and preprocess the AFHQ dataset</li>
<li>Define the UNet architecture</li>
<li>Implement the diffusion process</li>
<li>Train the model</li>
<li>Generate new images</li>
</ol>
</section>
<section id="prerequisites" class="level3">
<h3 class="anchored" data-anchor-id="prerequisites">Prerequisites</h3>
<ul>
<li>PyTorch and <code>torchvision</code></li>
<li>datasets library (<code>pip install datasets==3.0.2</code>)</li>
<li>Basic understanding of deep learning and generative models</li>
</ul>
</section>
<section id="running-this-notebook-in-the-background" class="level3">
<h3 class="anchored" data-anchor-id="running-this-notebook-in-the-background">Running this notebook in the background</h3>
<p>This notebook can take a while to run. If you want to run it in the background, you can use the following command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> notebooks</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">papermill</span> 2_1_diffusion_afhq.ipynb 2_1_diffusion_afhq.ipynb  <span class="co"># requires `papermill`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="e5013927" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:11.736782Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:11.736372Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:11.739003Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:11.738622Z&quot;}" data-outputid="d2b5c8c3-27e8-442b-9f9f-cb83297d0063" data-papermill="{&quot;duration&quot;:0.043703,&quot;end_time&quot;:&quot;2025-02-18T03:35:11.739888&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:11.696185&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install datasets==3.0.2</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install torchvision==0.17.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d4d9608a" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:11.773680Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:11.773154Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:11.783046Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:11.782668Z&quot;}" data-papermill="{&quot;duration&quot;:0.028307,&quot;end_time&quot;:&quot;2025-02-18T03:35:11.783864&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:11.755557&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext autoreload</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>autoreload <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6d51e99a" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:11.816368Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:11.815735Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:13.655066Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:13.653881Z&quot;}" data-papermill="{&quot;duration&quot;:1.856881,&quot;end_time&quot;:&quot;2025-02-18T03:35:13.656416&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:11.799535&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> transforms</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader, random_split</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.nn <span class="im">import</span> MSELoss</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.utils <span class="im">import</span> make_grid</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, Tuple</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="training-configuration" class="level2">
<h2 class="anchored" data-anchor-id="training-configuration">Training Configuration</h2>
<p>The <code>TrainingConfig</code> class below defines all hyperparameters for our model: - Dataset: AFHQ dataset at 64x64 resolution - Model architecture: UNet with attention - Training parameters: batch size, learning rate, etc. - Data augmentation options</p>
<div id="d620610f" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:13.718148Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:13.717782Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:13.732483Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:13.731138Z&quot;}" data-papermill="{&quot;duration&quot;:0.031588,&quot;end_time&quot;:&quot;2025-02-18T03:35:13.733389&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:13.701801&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TrainingConfig:</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    dataset: <span class="bu">str</span> <span class="op">=</span> <span class="st">"zzsi/afhq64_16k"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model architecture</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    resolution: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span> <span class="co"># resolution of the image</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    num_denoising_steps: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1000</span> <span class="co"># number of timesteps</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training loop and optimizer</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    total_steps: <span class="bu">int</span> <span class="op">=</span> <span class="dv">100000</span>  <span class="co"># total number of training steps</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">32</span> <span class="co"># batch size</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    learning_rate: <span class="bu">float</span> <span class="op">=</span> <span class="fl">5e-4</span> <span class="co"># initial learning rate</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    weight_decay: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1e-6</span> <span class="co"># weight decay</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data augmentation</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    random_flip: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span> <span class="co"># randomly flip images horizontally</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> TrainingConfig(resolution<span class="op">=</span><span class="dv">64</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-data" class="level2">
<h2 class="anchored" data-anchor-id="load-data">Load data</h2>
<p>We use the HuggingFace datasets library to load the AFHQ dataset. The data pipeline includes: - Loading images from HuggingFace - Resizing to the target resolution - Applying normalization and optional augmentations</p>
<div id="358723a6" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:13.794588Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:13.794177Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:16.088406Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:16.087977Z&quot;}" data-outputid="ebcded33-8efd-4e60-d5ef-caf0ecd87062" data-papermill="{&quot;duration&quot;:2.311235,&quot;end_time&quot;:&quot;2025-02-18T03:35:16.089565&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:13.778330&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HuggingFaceDataset(Dataset):</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, dataset_path: <span class="bu">str</span>, transform<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dataset <span class="op">=</span> load_dataset(dataset_path, split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transform <span class="op">=</span> transform</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_key <span class="op">=</span> <span class="va">self</span>.find_image_key()</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find_image_key(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if the dataset has the "image" key</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">NOTE</span><span class="co">: Can exapnd this to other common keys if needed</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"image"</span> <span class="kw">in</span> <span class="va">self</span>.dataset[<span class="dv">0</span>].keys():</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"image"</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="st">"Dataset does not have an 'image' key"</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.dataset)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> <span class="va">self</span>.dataset[idx][<span class="va">self</span>.image_key]</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> image.convert(<span class="st">"RGB"</span>)  <span class="co"># Convert to RGB to ensure 3 channels</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># By default, set label to 0 to conform to current expected batch format</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.transform:</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>            image <span class="op">=</span> <span class="va">self</span>.transform(image)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image, label</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_data(config: TrainingConfig) <span class="op">-&gt;</span> Tuple[DataLoader, DataLoader]:</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    resolution <span class="op">=</span> config.resolution</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    transforms_list <span class="op">=</span> [</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        transforms.Resize((resolution, resolution)),</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        transforms.ToTensor(),</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        transforms.Normalize((<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>), (<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>)),</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> config.random_flip:</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        transforms_list.insert(<span class="dv">0</span>, transforms.RandomHorizontalFlip())</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    transform <span class="op">=</span> transforms.Compose(transforms_list)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    full_dataset <span class="op">=</span> HuggingFaceDataset(config.dataset, transform<span class="op">=</span>transform)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    train_size <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.9</span> <span class="op">*</span> <span class="bu">len</span>(full_dataset))</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    val_size <span class="op">=</span> <span class="bu">len</span>(full_dataset) <span class="op">-</span> train_size</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    train_dataset, val_dataset <span class="op">=</span> random_split(full_dataset, [train_size, val_size], generator<span class="op">=</span>torch.Generator().manual_seed(<span class="dv">0</span>))</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    train_dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        train_dataset, batch_size<span class="op">=</span>config.batch_size, shuffle<span class="op">=</span><span class="va">True</span>, num_workers<span class="op">=</span><span class="dv">2</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    val_dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        val_dataset, batch_size<span class="op">=</span>config.batch_size, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_dataloader, val_dataloader</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>train_dataloader, val_dataloader <span class="op">=</span> load_data(config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="04d9539e" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:16.122439Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:16.122187Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:16.665898Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:16.665455Z&quot;}" data-outputid="fd4bd221-815c-45dd-bc10-da980d048d3d" data-papermill="{&quot;duration&quot;:0.562295,&quot;end_time&quot;:&quot;2025-02-18T03:35:16.668201&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:16.105906&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(train_dataloader))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>grid_img <span class="op">=</span> make_grid(x[<span class="dv">0</span>]).permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>grid_img <span class="op">=</span> (grid_img <span class="op">-</span> grid_img.<span class="bu">min</span>()) <span class="op">/</span> (grid_img.<span class="bu">max</span>() <span class="op">-</span> grid_img.<span class="bu">min</span>())</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>plt.imshow(grid_img)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2_1_diffusion_afhq_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="create-model-components-for-diffusion" class="level2">
<h2 class="anchored" data-anchor-id="create-model-components-for-diffusion">Create model components for diffusion</h2>
<p>For image generation, a typical model architecture can be a UNet or a transformer. We use UNet in this notebook.</p>
<p>Below are some utility functions and classesfor the model architecture.</p>
<section id="library-code-for-model-architecture" class="level3">
<h3 class="anchored" data-anchor-id="library-code-for-model-architecture">Library code for model architecture</h3>
<p>The code that defines the UNet model architecture is a bit long. Since it is a fairly standard architecture, we don’t need to go into the details here. Feel free to skip the code block below.</p>
<div id="d0b49b17" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:16.783238Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:16.782518Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:16.847414Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:16.846986Z&quot;}" data-papermill="{&quot;duration&quot;:0.087031,&quot;end_time&quot;:&quot;2025-02-18T03:35:16.848722&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:16.761691&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">From: https://github.com/VSehwag/minimal-diffusion/blob/main/unets.py</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> abc <span class="im">import</span> abstractmethod</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch <span class="im">as</span> th</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GroupNorm32(nn.GroupNorm):</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">super</span>().forward(x.<span class="bu">float</span>()).<span class="bu">type</span>(x.dtype)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> conv_nd(dims, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a 1D, 2D, or 3D convolution module.</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dims <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> nn.Conv1d(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> dims <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> nn.Conv2d(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> dims <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> nn.Conv3d(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"unsupported dimensions: </span><span class="sc">{</span>dims<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> linear(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a linear module.</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nn.Linear(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> avg_pool_nd(dims, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a 1D, 2D, or 3D average pooling module.</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dims <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> nn.AvgPool1d(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> dims <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> nn.AvgPool2d(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> dims <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> nn.AvgPool3d(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"unsupported dimensions: </span><span class="sc">{</span>dims<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update_ema(target_params, source_params, rate<span class="op">=</span><span class="fl">0.99</span>):</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a><span class="co">    Update target parameters to be closer to those of source parameters using</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="co">    an exponential moving average.</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="co">    :param target_params: the target parameter sequence.</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="co">    :param source_params: the source parameter sequence.</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="co">    :param rate: the EMA rate (closer to 1 means slower).</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> targ, src <span class="kw">in</span> <span class="bu">zip</span>(target_params, source_params):</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        targ.detach().mul_(rate).add_(src, alpha<span class="op">=</span><span class="dv">1</span> <span class="op">-</span> rate)</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> zero_module(module):</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a><span class="co">    Zero out the parameters of a module and return it.</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> module.parameters():</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>        p.detach().zero_()</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> module</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalization(channels):</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a><span class="co">    Make a standard normalization layer.</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a><span class="co">    :param channels: number of input channels.</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a><span class="co">    :return: an nn.Module for normalization.</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> GroupNorm32(<span class="dv">32</span>, channels)</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> timestep_embedding(timesteps, dim, max_period<span class="op">=</span><span class="dv">10000</span>):</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a><span class="co">    Create sinusoidal timestep embeddings.</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a><span class="co">    :param timesteps: a 1-D Tensor of N indices, one per batch element.</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a><span class="co">                      These may be fractional.</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dim: the dimension of the output.</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a><span class="co">    :param max_period: controls the minimum frequency of the embeddings.</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a><span class="co">    :return: an [N x dim] Tensor of positional embeddings.</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>    half <span class="op">=</span> dim <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>    freqs <span class="op">=</span> th.exp(</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span>math.log(max_period) <span class="op">*</span> th.arange(start<span class="op">=</span><span class="dv">0</span>, end<span class="op">=</span>half, dtype<span class="op">=</span>th.float32) <span class="op">/</span> half</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>    ).to(device<span class="op">=</span>timesteps.device)</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> timesteps.ndim <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>        args <span class="op">=</span> timesteps[:, <span class="va">None</span>].<span class="bu">float</span>() <span class="op">*</span> freqs[<span class="va">None</span>]</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>        args <span class="op">=</span> timesteps.<span class="bu">float</span>() <span class="op">*</span> freqs[<span class="va">None</span>]</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>    embedding <span class="op">=</span> th.cat([th.cos(args), th.sin(args)], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dim <span class="op">%</span> <span class="dv">2</span>:</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>        embedding <span class="op">=</span> th.cat([embedding, th.zeros_like(embedding[:, :<span class="dv">1</span>])], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> embedding</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> checkpoint(func, inputs, params, flag):</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a><span class="co">    Evaluate a function without caching intermediate activations, allowing for</span></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a><span class="co">    reduced memory at the expense of extra compute in the backward pass.</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a><span class="co">    :param func: the function to evaluate.</span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a><span class="co">    :param inputs: the argument sequence to pass to `func`.</span></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a><span class="co">    :param params: a sequence of parameters `func` depends on but does not</span></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a><span class="co">                   explicitly take as arguments.</span></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a><span class="co">    :param flag: if False, disable gradient checkpointing.</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> flag:</span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>        args <span class="op">=</span> <span class="bu">tuple</span>(inputs) <span class="op">+</span> <span class="bu">tuple</span>(params)</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> CheckpointFunction.<span class="bu">apply</span>(func, <span class="bu">len</span>(inputs), <span class="op">*</span>args)</span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func(<span class="op">*</span>inputs)</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckpointFunction(th.autograd.Function):</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(ctx, run_function, length, <span class="op">*</span>args):</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>        ctx.run_function <span class="op">=</span> run_function</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>        ctx.input_tensors <span class="op">=</span> <span class="bu">list</span>(args[:length])</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>        ctx.input_params <span class="op">=</span> <span class="bu">list</span>(args[length:])</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> th.no_grad():</span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>            output_tensors <span class="op">=</span> ctx.run_function(<span class="op">*</span>ctx.input_tensors)</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output_tensors</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> backward(ctx, <span class="op">*</span>output_grads):</span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>        ctx.input_tensors <span class="op">=</span> [x.detach().requires_grad_(<span class="va">True</span>) <span class="cf">for</span> x <span class="kw">in</span> ctx.input_tensors]</span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> th.enable_grad():</span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fixes a bug where the first op in run_function modifies the</span></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Tensor storage in place, which is not allowed for detach()'d</span></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Tensors.</span></span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>            shallow_copies <span class="op">=</span> [x.view_as(x) <span class="cf">for</span> x <span class="kw">in</span> ctx.input_tensors]</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>            output_tensors <span class="op">=</span> ctx.run_function(<span class="op">*</span>shallow_copies)</span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>        input_grads <span class="op">=</span> th.autograd.grad(</span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>            output_tensors,</span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>            ctx.input_tensors <span class="op">+</span> ctx.input_params,</span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>            output_grads,</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>            allow_unused<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> ctx.input_tensors</span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> ctx.input_params</span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> output_tensors</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="va">None</span>, <span class="va">None</span>) <span class="op">+</span> input_grads</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AttentionPool2d(nn.Module):</span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a><span class="co">    Adapted from CLIP: https://github.com/openai/CLIP/blob/main/clip/model.py</span></span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>        spacial_dim: <span class="bu">int</span>,</span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a>        embed_dim: <span class="bu">int</span>,</span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>        num_heads_channels: <span class="bu">int</span>,</span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a>        output_dim: <span class="bu">int</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.positional_embedding <span class="op">=</span> nn.Parameter(</span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>            th.randn(embed_dim, spacial_dim <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> embed_dim <span class="op">**</span> <span class="fl">0.5</span></span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.qkv_proj <span class="op">=</span> conv_nd(<span class="dv">1</span>, embed_dim, <span class="dv">3</span> <span class="op">*</span> embed_dim, <span class="dv">1</span>)</span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.c_proj <span class="op">=</span> conv_nd(<span class="dv">1</span>, embed_dim, output_dim <span class="kw">or</span> embed_dim, <span class="dv">1</span>)</span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_heads <span class="op">=</span> embed_dim <span class="op">//</span> num_heads_channels</span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.attention <span class="op">=</span> QKVAttention(<span class="va">self</span>.num_heads)</span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a>        b, c, <span class="op">*</span>_spatial <span class="op">=</span> x.shape</span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x.reshape(b, c, <span class="op">-</span><span class="dv">1</span>)  <span class="co"># NC(HW)</span></span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> th.cat([x.mean(dim<span class="op">=-</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>), x], dim<span class="op">=-</span><span class="dv">1</span>)  <span class="co"># NC(HW+1)</span></span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x <span class="op">+</span> <span class="va">self</span>.positional_embedding[<span class="va">None</span>, :, :].to(x.dtype)  <span class="co"># NC(HW+1)</span></span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.qkv_proj(x)</span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.attention(x)</span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.c_proj(x)</span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x[:, :, <span class="dv">0</span>]</span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TimestepBlock(nn.Module):</span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a><span class="co">    Any module where forward() takes timestep embeddings as a second argument.</span></span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">@abstractmethod</span></span>
<span id="cb8-194"><a href="#cb8-194" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, emb):</span>
<span id="cb8-195"><a href="#cb8-195" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a><span class="co">        Apply the module to `x` given `emb` timestep embeddings.</span></span>
<span id="cb8-197"><a href="#cb8-197" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb8-198"><a href="#cb8-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-199"><a href="#cb8-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-200"><a href="#cb8-200" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TimestepEmbedSequential(nn.Sequential, TimestepBlock):</span>
<span id="cb8-201"><a href="#cb8-201" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-202"><a href="#cb8-202" aria-hidden="true" tabindex="-1"></a><span class="co">    A sequential module that passes timestep embeddings to the children that</span></span>
<span id="cb8-203"><a href="#cb8-203" aria-hidden="true" tabindex="-1"></a><span class="co">    support it as an extra input.</span></span>
<span id="cb8-204"><a href="#cb8-204" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-205"><a href="#cb8-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-206"><a href="#cb8-206" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, emb):</span>
<span id="cb8-207"><a href="#cb8-207" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layer <span class="kw">in</span> <span class="va">self</span>:</span>
<span id="cb8-208"><a href="#cb8-208" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(layer, TimestepBlock):</span>
<span id="cb8-209"><a href="#cb8-209" aria-hidden="true" tabindex="-1"></a>                x <span class="op">=</span> layer(x, emb)</span>
<span id="cb8-210"><a href="#cb8-210" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb8-211"><a href="#cb8-211" aria-hidden="true" tabindex="-1"></a>                x <span class="op">=</span> layer(x)</span>
<span id="cb8-212"><a href="#cb8-212" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb8-213"><a href="#cb8-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-214"><a href="#cb8-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-215"><a href="#cb8-215" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Upsample(nn.Module):</span>
<span id="cb8-216"><a href="#cb8-216" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-217"><a href="#cb8-217" aria-hidden="true" tabindex="-1"></a><span class="co">    An upsampling layer with an optional convolution.</span></span>
<span id="cb8-218"><a href="#cb8-218" aria-hidden="true" tabindex="-1"></a><span class="co">    :param channels: channels in the inputs and outputs.</span></span>
<span id="cb8-219"><a href="#cb8-219" aria-hidden="true" tabindex="-1"></a><span class="co">    :param use_conv: a bool determining if a convolution is applied.</span></span>
<span id="cb8-220"><a href="#cb8-220" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dims: determines if the signal is 1D, 2D, or 3D. If 3D, then</span></span>
<span id="cb8-221"><a href="#cb8-221" aria-hidden="true" tabindex="-1"></a><span class="co">                 upsampling occurs in the inner-two dimensions.</span></span>
<span id="cb8-222"><a href="#cb8-222" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-223"><a href="#cb8-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-224"><a href="#cb8-224" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, channels, use_conv, dims<span class="op">=</span><span class="dv">2</span>, out_channels<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb8-225"><a href="#cb8-225" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb8-226"><a href="#cb8-226" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.channels <span class="op">=</span> channels</span>
<span id="cb8-227"><a href="#cb8-227" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out_channels <span class="op">=</span> out_channels <span class="kw">or</span> channels</span>
<span id="cb8-228"><a href="#cb8-228" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_conv <span class="op">=</span> use_conv</span>
<span id="cb8-229"><a href="#cb8-229" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dims <span class="op">=</span> dims</span>
<span id="cb8-230"><a href="#cb8-230" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_conv:</span>
<span id="cb8-231"><a href="#cb8-231" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.conv <span class="op">=</span> conv_nd(dims, <span class="va">self</span>.channels, <span class="va">self</span>.out_channels, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-232"><a href="#cb8-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-233"><a href="#cb8-233" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb8-234"><a href="#cb8-234" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> x.shape[<span class="dv">1</span>] <span class="op">==</span> <span class="va">self</span>.channels</span>
<span id="cb8-235"><a href="#cb8-235" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.dims <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb8-236"><a href="#cb8-236" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> F.interpolate(</span>
<span id="cb8-237"><a href="#cb8-237" aria-hidden="true" tabindex="-1"></a>                x, (x.shape[<span class="dv">2</span>], x.shape[<span class="dv">3</span>] <span class="op">*</span> <span class="dv">2</span>, x.shape[<span class="dv">4</span>] <span class="op">*</span> <span class="dv">2</span>), mode<span class="op">=</span><span class="st">"nearest"</span></span>
<span id="cb8-238"><a href="#cb8-238" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-239"><a href="#cb8-239" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-240"><a href="#cb8-240" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> F.interpolate(x, scale_factor<span class="op">=</span><span class="dv">2</span>, mode<span class="op">=</span><span class="st">"nearest"</span>)</span>
<span id="cb8-241"><a href="#cb8-241" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> x.shape[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> x.shape[<span class="op">-</span><span class="dv">2</span>] <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb8-242"><a href="#cb8-242" aria-hidden="true" tabindex="-1"></a>            <span class="co"># upsampling layer transform [3x3] to [6x6]. Manually paddding it to make [7x7]</span></span>
<span id="cb8-243"><a href="#cb8-243" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> F.pad(out, (<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb8-244"><a href="#cb8-244" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.use_conv:</span>
<span id="cb8-245"><a href="#cb8-245" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> <span class="va">self</span>.conv(out)</span>
<span id="cb8-246"><a href="#cb8-246" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> out</span>
<span id="cb8-247"><a href="#cb8-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-248"><a href="#cb8-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-249"><a href="#cb8-249" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Downsample(nn.Module):</span>
<span id="cb8-250"><a href="#cb8-250" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-251"><a href="#cb8-251" aria-hidden="true" tabindex="-1"></a><span class="co">    A downsampling layer with an optional convolution.</span></span>
<span id="cb8-252"><a href="#cb8-252" aria-hidden="true" tabindex="-1"></a><span class="co">    :param channels: channels in the inputs and outputs.</span></span>
<span id="cb8-253"><a href="#cb8-253" aria-hidden="true" tabindex="-1"></a><span class="co">    :param use_conv: a bool determining if a convolution is applied.</span></span>
<span id="cb8-254"><a href="#cb8-254" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dims: determines if the signal is 1D, 2D, or 3D. If 3D, then</span></span>
<span id="cb8-255"><a href="#cb8-255" aria-hidden="true" tabindex="-1"></a><span class="co">                 downsampling occurs in the inner-two dimensions.</span></span>
<span id="cb8-256"><a href="#cb8-256" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-257"><a href="#cb8-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-258"><a href="#cb8-258" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, channels, use_conv, dims<span class="op">=</span><span class="dv">2</span>, out_channels<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb8-259"><a href="#cb8-259" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb8-260"><a href="#cb8-260" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.channels <span class="op">=</span> channels</span>
<span id="cb8-261"><a href="#cb8-261" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out_channels <span class="op">=</span> out_channels <span class="kw">or</span> channels</span>
<span id="cb8-262"><a href="#cb8-262" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_conv <span class="op">=</span> use_conv</span>
<span id="cb8-263"><a href="#cb8-263" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dims <span class="op">=</span> dims</span>
<span id="cb8-264"><a href="#cb8-264" aria-hidden="true" tabindex="-1"></a>        stride <span class="op">=</span> <span class="dv">2</span> <span class="cf">if</span> dims <span class="op">!=</span> <span class="dv">3</span> <span class="cf">else</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb8-265"><a href="#cb8-265" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_conv:</span>
<span id="cb8-266"><a href="#cb8-266" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.op <span class="op">=</span> conv_nd(</span>
<span id="cb8-267"><a href="#cb8-267" aria-hidden="true" tabindex="-1"></a>                dims, <span class="va">self</span>.channels, <span class="va">self</span>.out_channels, <span class="dv">3</span>, stride<span class="op">=</span>stride, padding<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-268"><a href="#cb8-268" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-269"><a href="#cb8-269" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-270"><a href="#cb8-270" aria-hidden="true" tabindex="-1"></a>            <span class="cf">assert</span> <span class="va">self</span>.channels <span class="op">==</span> <span class="va">self</span>.out_channels</span>
<span id="cb8-271"><a href="#cb8-271" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.op <span class="op">=</span> avg_pool_nd(dims, kernel_size<span class="op">=</span>stride, stride<span class="op">=</span>stride)</span>
<span id="cb8-272"><a href="#cb8-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-273"><a href="#cb8-273" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb8-274"><a href="#cb8-274" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> x.shape[<span class="dv">1</span>] <span class="op">==</span> <span class="va">self</span>.channels</span>
<span id="cb8-275"><a href="#cb8-275" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.op(x)</span>
<span id="cb8-276"><a href="#cb8-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-277"><a href="#cb8-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-278"><a href="#cb8-278" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResBlock(TimestepBlock):</span>
<span id="cb8-279"><a href="#cb8-279" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-280"><a href="#cb8-280" aria-hidden="true" tabindex="-1"></a><span class="co">    A residual block that can optionally change the number of channels.</span></span>
<span id="cb8-281"><a href="#cb8-281" aria-hidden="true" tabindex="-1"></a><span class="co">    :param channels: the number of input channels.</span></span>
<span id="cb8-282"><a href="#cb8-282" aria-hidden="true" tabindex="-1"></a><span class="co">    :param emb_channels: the number of timestep embedding channels.</span></span>
<span id="cb8-283"><a href="#cb8-283" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dropout: the rate of dropout.</span></span>
<span id="cb8-284"><a href="#cb8-284" aria-hidden="true" tabindex="-1"></a><span class="co">    :param out_channels: if specified, the number of out channels.</span></span>
<span id="cb8-285"><a href="#cb8-285" aria-hidden="true" tabindex="-1"></a><span class="co">    :param use_conv: if True and out_channels is specified, use a spatial</span></span>
<span id="cb8-286"><a href="#cb8-286" aria-hidden="true" tabindex="-1"></a><span class="co">        convolution instead of a smaller 1x1 convolution to change the</span></span>
<span id="cb8-287"><a href="#cb8-287" aria-hidden="true" tabindex="-1"></a><span class="co">        channels in the skip connection.</span></span>
<span id="cb8-288"><a href="#cb8-288" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dims: determines if the signal is 1D, 2D, or 3D.</span></span>
<span id="cb8-289"><a href="#cb8-289" aria-hidden="true" tabindex="-1"></a><span class="co">    :param use_checkpoint: if True, use gradient checkpointing on this module.</span></span>
<span id="cb8-290"><a href="#cb8-290" aria-hidden="true" tabindex="-1"></a><span class="co">    :param up: if True, use this block for upsampling.</span></span>
<span id="cb8-291"><a href="#cb8-291" aria-hidden="true" tabindex="-1"></a><span class="co">    :param down: if True, use this block for downsampling.</span></span>
<span id="cb8-292"><a href="#cb8-292" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-293"><a href="#cb8-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-294"><a href="#cb8-294" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb8-295"><a href="#cb8-295" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb8-296"><a href="#cb8-296" aria-hidden="true" tabindex="-1"></a>        channels,</span>
<span id="cb8-297"><a href="#cb8-297" aria-hidden="true" tabindex="-1"></a>        emb_channels,</span>
<span id="cb8-298"><a href="#cb8-298" aria-hidden="true" tabindex="-1"></a>        dropout,</span>
<span id="cb8-299"><a href="#cb8-299" aria-hidden="true" tabindex="-1"></a>        out_channels<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb8-300"><a href="#cb8-300" aria-hidden="true" tabindex="-1"></a>        use_conv<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-301"><a href="#cb8-301" aria-hidden="true" tabindex="-1"></a>        use_scale_shift_norm<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-302"><a href="#cb8-302" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb8-303"><a href="#cb8-303" aria-hidden="true" tabindex="-1"></a>        use_checkpoint<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-304"><a href="#cb8-304" aria-hidden="true" tabindex="-1"></a>        up<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-305"><a href="#cb8-305" aria-hidden="true" tabindex="-1"></a>        down<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-306"><a href="#cb8-306" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb8-307"><a href="#cb8-307" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb8-308"><a href="#cb8-308" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.channels <span class="op">=</span> channels</span>
<span id="cb8-309"><a href="#cb8-309" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.emb_channels <span class="op">=</span> emb_channels</span>
<span id="cb8-310"><a href="#cb8-310" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> dropout</span>
<span id="cb8-311"><a href="#cb8-311" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out_channels <span class="op">=</span> out_channels <span class="kw">or</span> channels</span>
<span id="cb8-312"><a href="#cb8-312" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_conv <span class="op">=</span> use_conv</span>
<span id="cb8-313"><a href="#cb8-313" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_checkpoint <span class="op">=</span> use_checkpoint</span>
<span id="cb8-314"><a href="#cb8-314" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_scale_shift_norm <span class="op">=</span> use_scale_shift_norm</span>
<span id="cb8-315"><a href="#cb8-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-316"><a href="#cb8-316" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.in_layers <span class="op">=</span> nn.Sequential(</span>
<span id="cb8-317"><a href="#cb8-317" aria-hidden="true" tabindex="-1"></a>            normalization(channels),</span>
<span id="cb8-318"><a href="#cb8-318" aria-hidden="true" tabindex="-1"></a>            nn.SiLU(),</span>
<span id="cb8-319"><a href="#cb8-319" aria-hidden="true" tabindex="-1"></a>            conv_nd(dims, channels, <span class="va">self</span>.out_channels, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb8-320"><a href="#cb8-320" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-321"><a href="#cb8-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-322"><a href="#cb8-322" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.updown <span class="op">=</span> up <span class="kw">or</span> down</span>
<span id="cb8-323"><a href="#cb8-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-324"><a href="#cb8-324" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> up:</span>
<span id="cb8-325"><a href="#cb8-325" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.h_upd <span class="op">=</span> Upsample(channels, <span class="va">False</span>, dims)</span>
<span id="cb8-326"><a href="#cb8-326" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.x_upd <span class="op">=</span> Upsample(channels, <span class="va">False</span>, dims)</span>
<span id="cb8-327"><a href="#cb8-327" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> down:</span>
<span id="cb8-328"><a href="#cb8-328" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.h_upd <span class="op">=</span> Downsample(channels, <span class="va">False</span>, dims)</span>
<span id="cb8-329"><a href="#cb8-329" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.x_upd <span class="op">=</span> Downsample(channels, <span class="va">False</span>, dims)</span>
<span id="cb8-330"><a href="#cb8-330" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-331"><a href="#cb8-331" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.h_upd <span class="op">=</span> <span class="va">self</span>.x_upd <span class="op">=</span> nn.Identity()</span>
<span id="cb8-332"><a href="#cb8-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-333"><a href="#cb8-333" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.emb_layers <span class="op">=</span> nn.Sequential(</span>
<span id="cb8-334"><a href="#cb8-334" aria-hidden="true" tabindex="-1"></a>            nn.SiLU(),</span>
<span id="cb8-335"><a href="#cb8-335" aria-hidden="true" tabindex="-1"></a>            linear(</span>
<span id="cb8-336"><a href="#cb8-336" aria-hidden="true" tabindex="-1"></a>                emb_channels,</span>
<span id="cb8-337"><a href="#cb8-337" aria-hidden="true" tabindex="-1"></a>                <span class="dv">2</span> <span class="op">*</span> <span class="va">self</span>.out_channels <span class="cf">if</span> use_scale_shift_norm <span class="cf">else</span> <span class="va">self</span>.out_channels,</span>
<span id="cb8-338"><a href="#cb8-338" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb8-339"><a href="#cb8-339" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-340"><a href="#cb8-340" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out_layers <span class="op">=</span> nn.Sequential(</span>
<span id="cb8-341"><a href="#cb8-341" aria-hidden="true" tabindex="-1"></a>            normalization(<span class="va">self</span>.out_channels),</span>
<span id="cb8-342"><a href="#cb8-342" aria-hidden="true" tabindex="-1"></a>            nn.SiLU(),</span>
<span id="cb8-343"><a href="#cb8-343" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(p<span class="op">=</span>dropout),</span>
<span id="cb8-344"><a href="#cb8-344" aria-hidden="true" tabindex="-1"></a>            zero_module(</span>
<span id="cb8-345"><a href="#cb8-345" aria-hidden="true" tabindex="-1"></a>                conv_nd(dims, <span class="va">self</span>.out_channels, <span class="va">self</span>.out_channels, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-346"><a href="#cb8-346" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb8-347"><a href="#cb8-347" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-348"><a href="#cb8-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-349"><a href="#cb8-349" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.out_channels <span class="op">==</span> channels:</span>
<span id="cb8-350"><a href="#cb8-350" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.skip_connection <span class="op">=</span> nn.Identity()</span>
<span id="cb8-351"><a href="#cb8-351" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> use_conv:</span>
<span id="cb8-352"><a href="#cb8-352" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.skip_connection <span class="op">=</span> conv_nd(</span>
<span id="cb8-353"><a href="#cb8-353" aria-hidden="true" tabindex="-1"></a>                dims, channels, <span class="va">self</span>.out_channels, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-354"><a href="#cb8-354" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-355"><a href="#cb8-355" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-356"><a href="#cb8-356" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.skip_connection <span class="op">=</span> conv_nd(dims, channels, <span class="va">self</span>.out_channels, <span class="dv">1</span>)</span>
<span id="cb8-357"><a href="#cb8-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-358"><a href="#cb8-358" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, emb):</span>
<span id="cb8-359"><a href="#cb8-359" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb8-360"><a href="#cb8-360" aria-hidden="true" tabindex="-1"></a><span class="co">        Apply the block to a Tensor, conditioned on a timestep embedding.</span></span>
<span id="cb8-361"><a href="#cb8-361" aria-hidden="true" tabindex="-1"></a><span class="co">        :param x: an [N x C x ...] Tensor of features.</span></span>
<span id="cb8-362"><a href="#cb8-362" aria-hidden="true" tabindex="-1"></a><span class="co">        :param emb: an [N x emb_channels] Tensor of timestep embeddings.</span></span>
<span id="cb8-363"><a href="#cb8-363" aria-hidden="true" tabindex="-1"></a><span class="co">        :return: an [N x C x ...] Tensor of outputs.</span></span>
<span id="cb8-364"><a href="#cb8-364" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb8-365"><a href="#cb8-365" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> checkpoint(</span>
<span id="cb8-366"><a href="#cb8-366" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._forward, (x, emb), <span class="va">self</span>.parameters(), <span class="va">self</span>.use_checkpoint</span>
<span id="cb8-367"><a href="#cb8-367" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-368"><a href="#cb8-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-369"><a href="#cb8-369" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _forward(<span class="va">self</span>, x, emb):</span>
<span id="cb8-370"><a href="#cb8-370" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.updown:</span>
<span id="cb8-371"><a href="#cb8-371" aria-hidden="true" tabindex="-1"></a>            in_rest, in_conv <span class="op">=</span> <span class="va">self</span>.in_layers[:<span class="op">-</span><span class="dv">1</span>], <span class="va">self</span>.in_layers[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb8-372"><a href="#cb8-372" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> in_rest(x)</span>
<span id="cb8-373"><a href="#cb8-373" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> <span class="va">self</span>.h_upd(h)</span>
<span id="cb8-374"><a href="#cb8-374" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> <span class="va">self</span>.x_upd(x)</span>
<span id="cb8-375"><a href="#cb8-375" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> in_conv(h)</span>
<span id="cb8-376"><a href="#cb8-376" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-377"><a href="#cb8-377" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> <span class="va">self</span>.in_layers(x)</span>
<span id="cb8-378"><a href="#cb8-378" aria-hidden="true" tabindex="-1"></a>        emb_out <span class="op">=</span> <span class="va">self</span>.emb_layers(emb).<span class="bu">type</span>(h.dtype)</span>
<span id="cb8-379"><a href="#cb8-379" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="bu">len</span>(emb_out.shape) <span class="op">&lt;</span> <span class="bu">len</span>(h.shape):</span>
<span id="cb8-380"><a href="#cb8-380" aria-hidden="true" tabindex="-1"></a>            emb_out <span class="op">=</span> emb_out[..., <span class="va">None</span>]</span>
<span id="cb8-381"><a href="#cb8-381" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.use_scale_shift_norm:</span>
<span id="cb8-382"><a href="#cb8-382" aria-hidden="true" tabindex="-1"></a>            out_norm, out_rest <span class="op">=</span> <span class="va">self</span>.out_layers[<span class="dv">0</span>], <span class="va">self</span>.out_layers[<span class="dv">1</span>:]</span>
<span id="cb8-383"><a href="#cb8-383" aria-hidden="true" tabindex="-1"></a>            scale, shift <span class="op">=</span> th.chunk(emb_out, <span class="dv">2</span>, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-384"><a href="#cb8-384" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> out_norm(h) <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> scale) <span class="op">+</span> shift</span>
<span id="cb8-385"><a href="#cb8-385" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> out_rest(h)</span>
<span id="cb8-386"><a href="#cb8-386" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-387"><a href="#cb8-387" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> h <span class="op">+</span> emb_out</span>
<span id="cb8-388"><a href="#cb8-388" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> <span class="va">self</span>.out_layers(h)</span>
<span id="cb8-389"><a href="#cb8-389" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.skip_connection(x) <span class="op">+</span> h</span>
<span id="cb8-390"><a href="#cb8-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-391"><a href="#cb8-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-392"><a href="#cb8-392" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AttentionBlock(nn.Module):</span>
<span id="cb8-393"><a href="#cb8-393" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-394"><a href="#cb8-394" aria-hidden="true" tabindex="-1"></a><span class="co">    An attention block that allows spatial positions to attend to each other.</span></span>
<span id="cb8-395"><a href="#cb8-395" aria-hidden="true" tabindex="-1"></a><span class="co">    Originally ported from here, but adapted to the N-d case.</span></span>
<span id="cb8-396"><a href="#cb8-396" aria-hidden="true" tabindex="-1"></a><span class="co">    https://github.com/hojonathanho/diffusion/blob/1e0dceb3b3495bbe19116a5e1b3596cd0706c543/diffusion_tf/models/unet.py#L66.</span></span>
<span id="cb8-397"><a href="#cb8-397" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-398"><a href="#cb8-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-399"><a href="#cb8-399" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb8-400"><a href="#cb8-400" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb8-401"><a href="#cb8-401" aria-hidden="true" tabindex="-1"></a>        channels,</span>
<span id="cb8-402"><a href="#cb8-402" aria-hidden="true" tabindex="-1"></a>        num_heads<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb8-403"><a href="#cb8-403" aria-hidden="true" tabindex="-1"></a>        num_head_channels<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb8-404"><a href="#cb8-404" aria-hidden="true" tabindex="-1"></a>        use_checkpoint<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-405"><a href="#cb8-405" aria-hidden="true" tabindex="-1"></a>        use_new_attention_order<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-406"><a href="#cb8-406" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb8-407"><a href="#cb8-407" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb8-408"><a href="#cb8-408" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.channels <span class="op">=</span> channels</span>
<span id="cb8-409"><a href="#cb8-409" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> num_head_channels <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb8-410"><a href="#cb8-410" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.num_heads <span class="op">=</span> num_heads</span>
<span id="cb8-411"><a href="#cb8-411" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-412"><a href="#cb8-412" aria-hidden="true" tabindex="-1"></a>            <span class="cf">assert</span> (</span>
<span id="cb8-413"><a href="#cb8-413" aria-hidden="true" tabindex="-1"></a>                channels <span class="op">%</span> num_head_channels <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb8-414"><a href="#cb8-414" aria-hidden="true" tabindex="-1"></a>            ), <span class="ss">f"q,k,v channels </span><span class="sc">{</span>channels<span class="sc">}</span><span class="ss"> is not divisible by num_head_channels </span><span class="sc">{</span>num_head_channels<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb8-415"><a href="#cb8-415" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.num_heads <span class="op">=</span> channels <span class="op">//</span> num_head_channels</span>
<span id="cb8-416"><a href="#cb8-416" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_checkpoint <span class="op">=</span> use_checkpoint</span>
<span id="cb8-417"><a href="#cb8-417" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.norm <span class="op">=</span> normalization(channels)</span>
<span id="cb8-418"><a href="#cb8-418" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.qkv <span class="op">=</span> conv_nd(<span class="dv">1</span>, channels, channels <span class="op">*</span> <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb8-419"><a href="#cb8-419" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_new_attention_order:</span>
<span id="cb8-420"><a href="#cb8-420" aria-hidden="true" tabindex="-1"></a>            <span class="co"># split qkv before split heads</span></span>
<span id="cb8-421"><a href="#cb8-421" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.attention <span class="op">=</span> QKVAttention(<span class="va">self</span>.num_heads)</span>
<span id="cb8-422"><a href="#cb8-422" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-423"><a href="#cb8-423" aria-hidden="true" tabindex="-1"></a>            <span class="co"># split heads before split qkv</span></span>
<span id="cb8-424"><a href="#cb8-424" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.attention <span class="op">=</span> QKVAttentionLegacy(<span class="va">self</span>.num_heads)</span>
<span id="cb8-425"><a href="#cb8-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-426"><a href="#cb8-426" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.proj_out <span class="op">=</span> zero_module(conv_nd(<span class="dv">1</span>, channels, channels, <span class="dv">1</span>))</span>
<span id="cb8-427"><a href="#cb8-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-428"><a href="#cb8-428" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb8-429"><a href="#cb8-429" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> checkpoint(<span class="va">self</span>._forward, (x,), <span class="va">self</span>.parameters(), <span class="va">True</span>)</span>
<span id="cb8-430"><a href="#cb8-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-431"><a href="#cb8-431" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _forward(<span class="va">self</span>, x):</span>
<span id="cb8-432"><a href="#cb8-432" aria-hidden="true" tabindex="-1"></a>        b, c, <span class="op">*</span>spatial <span class="op">=</span> x.shape</span>
<span id="cb8-433"><a href="#cb8-433" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x.reshape(b, c, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb8-434"><a href="#cb8-434" aria-hidden="true" tabindex="-1"></a>        qkv <span class="op">=</span> <span class="va">self</span>.qkv(<span class="va">self</span>.norm(x))</span>
<span id="cb8-435"><a href="#cb8-435" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> <span class="va">self</span>.attention(qkv)</span>
<span id="cb8-436"><a href="#cb8-436" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> <span class="va">self</span>.proj_out(h)</span>
<span id="cb8-437"><a href="#cb8-437" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (x <span class="op">+</span> h).reshape(b, c, <span class="op">*</span>spatial)</span>
<span id="cb8-438"><a href="#cb8-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-439"><a href="#cb8-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-440"><a href="#cb8-440" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_flops_attn(model, _x, y):</span>
<span id="cb8-441"><a href="#cb8-441" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-442"><a href="#cb8-442" aria-hidden="true" tabindex="-1"></a><span class="co">    A counter for the `thop` package to count the operations in an</span></span>
<span id="cb8-443"><a href="#cb8-443" aria-hidden="true" tabindex="-1"></a><span class="co">    attention operation.</span></span>
<span id="cb8-444"><a href="#cb8-444" aria-hidden="true" tabindex="-1"></a><span class="co">    Meant to be used like:</span></span>
<span id="cb8-445"><a href="#cb8-445" aria-hidden="true" tabindex="-1"></a><span class="co">        macs, params = thop.profile(</span></span>
<span id="cb8-446"><a href="#cb8-446" aria-hidden="true" tabindex="-1"></a><span class="co">            model,</span></span>
<span id="cb8-447"><a href="#cb8-447" aria-hidden="true" tabindex="-1"></a><span class="co">            inputs=(inputs, timestamps),</span></span>
<span id="cb8-448"><a href="#cb8-448" aria-hidden="true" tabindex="-1"></a><span class="co">            custom_ops={QKVAttention: QKVAttention.count_flops},</span></span>
<span id="cb8-449"><a href="#cb8-449" aria-hidden="true" tabindex="-1"></a><span class="co">        )</span></span>
<span id="cb8-450"><a href="#cb8-450" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-451"><a href="#cb8-451" aria-hidden="true" tabindex="-1"></a>    b, c, <span class="op">*</span>spatial <span class="op">=</span> y[<span class="dv">0</span>].shape</span>
<span id="cb8-452"><a href="#cb8-452" aria-hidden="true" tabindex="-1"></a>    num_spatial <span class="op">=</span> <span class="bu">int</span>(np.prod(spatial))</span>
<span id="cb8-453"><a href="#cb8-453" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We perform two matmuls with the same number of ops.</span></span>
<span id="cb8-454"><a href="#cb8-454" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The first computes the weight matrix, the second computes</span></span>
<span id="cb8-455"><a href="#cb8-455" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the combination of the value vectors.</span></span>
<span id="cb8-456"><a href="#cb8-456" aria-hidden="true" tabindex="-1"></a>    matmul_ops <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> b <span class="op">*</span> (num_spatial <span class="op">**</span> <span class="dv">2</span>) <span class="op">*</span> c</span>
<span id="cb8-457"><a href="#cb8-457" aria-hidden="true" tabindex="-1"></a>    model.total_ops <span class="op">+=</span> th.DoubleTensor([matmul_ops])</span>
<span id="cb8-458"><a href="#cb8-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-459"><a href="#cb8-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-460"><a href="#cb8-460" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QKVAttentionLegacy(nn.Module):</span>
<span id="cb8-461"><a href="#cb8-461" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-462"><a href="#cb8-462" aria-hidden="true" tabindex="-1"></a><span class="co">    A module which performs QKV attention. Matches legacy QKVAttention + input/ouput heads shaping</span></span>
<span id="cb8-463"><a href="#cb8-463" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-464"><a href="#cb8-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-465"><a href="#cb8-465" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_heads):</span>
<span id="cb8-466"><a href="#cb8-466" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb8-467"><a href="#cb8-467" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_heads <span class="op">=</span> n_heads</span>
<span id="cb8-468"><a href="#cb8-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-469"><a href="#cb8-469" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, qkv):</span>
<span id="cb8-470"><a href="#cb8-470" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb8-471"><a href="#cb8-471" aria-hidden="true" tabindex="-1"></a><span class="co">        Apply QKV attention.</span></span>
<span id="cb8-472"><a href="#cb8-472" aria-hidden="true" tabindex="-1"></a><span class="co">        :param qkv: an [N x (H * 3 * C) x T] tensor of Qs, Ks, and Vs.</span></span>
<span id="cb8-473"><a href="#cb8-473" aria-hidden="true" tabindex="-1"></a><span class="co">        :return: an [N x (H * C) x T] tensor after attention.</span></span>
<span id="cb8-474"><a href="#cb8-474" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb8-475"><a href="#cb8-475" aria-hidden="true" tabindex="-1"></a>        bs, width, length <span class="op">=</span> qkv.shape</span>
<span id="cb8-476"><a href="#cb8-476" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> width <span class="op">%</span> (<span class="dv">3</span> <span class="op">*</span> <span class="va">self</span>.n_heads) <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb8-477"><a href="#cb8-477" aria-hidden="true" tabindex="-1"></a>        ch <span class="op">=</span> width <span class="op">//</span> (<span class="dv">3</span> <span class="op">*</span> <span class="va">self</span>.n_heads)</span>
<span id="cb8-478"><a href="#cb8-478" aria-hidden="true" tabindex="-1"></a>        q, k, v <span class="op">=</span> qkv.reshape(bs <span class="op">*</span> <span class="va">self</span>.n_heads, ch <span class="op">*</span> <span class="dv">3</span>, length).split(ch, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-479"><a href="#cb8-479" aria-hidden="true" tabindex="-1"></a>        scale <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> math.sqrt(math.sqrt(ch))</span>
<span id="cb8-480"><a href="#cb8-480" aria-hidden="true" tabindex="-1"></a>        weight <span class="op">=</span> th.einsum(</span>
<span id="cb8-481"><a href="#cb8-481" aria-hidden="true" tabindex="-1"></a>            <span class="st">"bct,bcs-&gt;bts"</span>, q <span class="op">*</span> scale, k <span class="op">*</span> scale</span>
<span id="cb8-482"><a href="#cb8-482" aria-hidden="true" tabindex="-1"></a>        )  <span class="co"># More stable with f16 than dividing afterwards</span></span>
<span id="cb8-483"><a href="#cb8-483" aria-hidden="true" tabindex="-1"></a>        weight <span class="op">=</span> th.softmax(weight.<span class="bu">float</span>(), dim<span class="op">=-</span><span class="dv">1</span>).<span class="bu">type</span>(weight.dtype)</span>
<span id="cb8-484"><a href="#cb8-484" aria-hidden="true" tabindex="-1"></a>        a <span class="op">=</span> th.einsum(<span class="st">"bts,bcs-&gt;bct"</span>, weight, v)</span>
<span id="cb8-485"><a href="#cb8-485" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a.reshape(bs, <span class="op">-</span><span class="dv">1</span>, length)</span>
<span id="cb8-486"><a href="#cb8-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-487"><a href="#cb8-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb8-488"><a href="#cb8-488" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> count_flops(model, _x, y):</span>
<span id="cb8-489"><a href="#cb8-489" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> count_flops_attn(model, _x, y)</span>
<span id="cb8-490"><a href="#cb8-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-491"><a href="#cb8-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-492"><a href="#cb8-492" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QKVAttention(nn.Module):</span>
<span id="cb8-493"><a href="#cb8-493" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-494"><a href="#cb8-494" aria-hidden="true" tabindex="-1"></a><span class="co">    A module which performs QKV attention and splits in a different order.</span></span>
<span id="cb8-495"><a href="#cb8-495" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-496"><a href="#cb8-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-497"><a href="#cb8-497" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_heads):</span>
<span id="cb8-498"><a href="#cb8-498" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb8-499"><a href="#cb8-499" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_heads <span class="op">=</span> n_heads</span>
<span id="cb8-500"><a href="#cb8-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-501"><a href="#cb8-501" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, qkv):</span>
<span id="cb8-502"><a href="#cb8-502" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb8-503"><a href="#cb8-503" aria-hidden="true" tabindex="-1"></a><span class="co">        Apply QKV attention.</span></span>
<span id="cb8-504"><a href="#cb8-504" aria-hidden="true" tabindex="-1"></a><span class="co">        :param qkv: an [N x (3 * H * C) x T] tensor of Qs, Ks, and Vs.</span></span>
<span id="cb8-505"><a href="#cb8-505" aria-hidden="true" tabindex="-1"></a><span class="co">        :return: an [N x (H * C) x T] tensor after attention.</span></span>
<span id="cb8-506"><a href="#cb8-506" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb8-507"><a href="#cb8-507" aria-hidden="true" tabindex="-1"></a>        bs, width, length <span class="op">=</span> qkv.shape</span>
<span id="cb8-508"><a href="#cb8-508" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> width <span class="op">%</span> (<span class="dv">3</span> <span class="op">*</span> <span class="va">self</span>.n_heads) <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb8-509"><a href="#cb8-509" aria-hidden="true" tabindex="-1"></a>        ch <span class="op">=</span> width <span class="op">//</span> (<span class="dv">3</span> <span class="op">*</span> <span class="va">self</span>.n_heads)</span>
<span id="cb8-510"><a href="#cb8-510" aria-hidden="true" tabindex="-1"></a>        q, k, v <span class="op">=</span> qkv.chunk(<span class="dv">3</span>, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-511"><a href="#cb8-511" aria-hidden="true" tabindex="-1"></a>        scale <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> math.sqrt(math.sqrt(ch))</span>
<span id="cb8-512"><a href="#cb8-512" aria-hidden="true" tabindex="-1"></a>        weight <span class="op">=</span> th.einsum(</span>
<span id="cb8-513"><a href="#cb8-513" aria-hidden="true" tabindex="-1"></a>            <span class="st">"bct,bcs-&gt;bts"</span>,</span>
<span id="cb8-514"><a href="#cb8-514" aria-hidden="true" tabindex="-1"></a>            (q <span class="op">*</span> scale).view(bs <span class="op">*</span> <span class="va">self</span>.n_heads, ch, length),</span>
<span id="cb8-515"><a href="#cb8-515" aria-hidden="true" tabindex="-1"></a>            (k <span class="op">*</span> scale).view(bs <span class="op">*</span> <span class="va">self</span>.n_heads, ch, length),</span>
<span id="cb8-516"><a href="#cb8-516" aria-hidden="true" tabindex="-1"></a>        )  <span class="co"># More stable with f16 than dividing afterwards</span></span>
<span id="cb8-517"><a href="#cb8-517" aria-hidden="true" tabindex="-1"></a>        weight <span class="op">=</span> th.softmax(weight.<span class="bu">float</span>(), dim<span class="op">=-</span><span class="dv">1</span>).<span class="bu">type</span>(weight.dtype)</span>
<span id="cb8-518"><a href="#cb8-518" aria-hidden="true" tabindex="-1"></a>        a <span class="op">=</span> th.einsum(<span class="st">"bts,bcs-&gt;bct"</span>, weight, v.reshape(bs <span class="op">*</span> <span class="va">self</span>.n_heads, ch, length))</span>
<span id="cb8-519"><a href="#cb8-519" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a.reshape(bs, <span class="op">-</span><span class="dv">1</span>, length)</span>
<span id="cb8-520"><a href="#cb8-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-521"><a href="#cb8-521" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb8-522"><a href="#cb8-522" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> count_flops(model, _x, y):</span>
<span id="cb8-523"><a href="#cb8-523" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> count_flops_attn(model, _x, y)</span>
<span id="cb8-524"><a href="#cb8-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-525"><a href="#cb8-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-526"><a href="#cb8-526" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UNetModel(nn.Module):</span>
<span id="cb8-527"><a href="#cb8-527" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-528"><a href="#cb8-528" aria-hidden="true" tabindex="-1"></a><span class="co">    The full UNet model with attention and timestep embedding.</span></span>
<span id="cb8-529"><a href="#cb8-529" aria-hidden="true" tabindex="-1"></a><span class="co">    :param in_channels: channels in the input Tensor.</span></span>
<span id="cb8-530"><a href="#cb8-530" aria-hidden="true" tabindex="-1"></a><span class="co">    :param emb_dim: base dimension of timestep embedding.</span></span>
<span id="cb8-531"><a href="#cb8-531" aria-hidden="true" tabindex="-1"></a><span class="co">    :param model_channels: base channel count for the model.</span></span>
<span id="cb8-532"><a href="#cb8-532" aria-hidden="true" tabindex="-1"></a><span class="co">    :param out_channels: channels in the output Tensor.</span></span>
<span id="cb8-533"><a href="#cb8-533" aria-hidden="true" tabindex="-1"></a><span class="co">    :param num_res_blocks: number of residual blocks per downsample.</span></span>
<span id="cb8-534"><a href="#cb8-534" aria-hidden="true" tabindex="-1"></a><span class="co">    :param attention_resolutions: a collection of downsample rates at which</span></span>
<span id="cb8-535"><a href="#cb8-535" aria-hidden="true" tabindex="-1"></a><span class="co">        attention will take place. May be a set, list, or tuple.</span></span>
<span id="cb8-536"><a href="#cb8-536" aria-hidden="true" tabindex="-1"></a><span class="co">        For example, if this contains 4, then at 4x downsampling, attention</span></span>
<span id="cb8-537"><a href="#cb8-537" aria-hidden="true" tabindex="-1"></a><span class="co">        will be used.</span></span>
<span id="cb8-538"><a href="#cb8-538" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dropout: the dropout probability.</span></span>
<span id="cb8-539"><a href="#cb8-539" aria-hidden="true" tabindex="-1"></a><span class="co">    :param channel_mult: channel multiplier for each level of the UNet.</span></span>
<span id="cb8-540"><a href="#cb8-540" aria-hidden="true" tabindex="-1"></a><span class="co">    :param conv_resample: if True, use learned convolutions for upsampling and</span></span>
<span id="cb8-541"><a href="#cb8-541" aria-hidden="true" tabindex="-1"></a><span class="co">        downsampling.</span></span>
<span id="cb8-542"><a href="#cb8-542" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dims: determines if the signal is 1D, 2D, or 3D.</span></span>
<span id="cb8-543"><a href="#cb8-543" aria-hidden="true" tabindex="-1"></a><span class="co">    :param num_classes: if specified (as an int), then this model will be</span></span>
<span id="cb8-544"><a href="#cb8-544" aria-hidden="true" tabindex="-1"></a><span class="co">        class-conditional with `num_classes` classes.</span></span>
<span id="cb8-545"><a href="#cb8-545" aria-hidden="true" tabindex="-1"></a><span class="co">    :param use_checkpoint: use gradient checkpointing to reduce memory usage.</span></span>
<span id="cb8-546"><a href="#cb8-546" aria-hidden="true" tabindex="-1"></a><span class="co">    :param num_heads: the number of attention heads in each attention layer.</span></span>
<span id="cb8-547"><a href="#cb8-547" aria-hidden="true" tabindex="-1"></a><span class="co">    :param num_heads_channels: if specified, ignore num_heads and instead use</span></span>
<span id="cb8-548"><a href="#cb8-548" aria-hidden="true" tabindex="-1"></a><span class="co">                               a fixed channel width per attention head.</span></span>
<span id="cb8-549"><a href="#cb8-549" aria-hidden="true" tabindex="-1"></a><span class="co">    :param num_heads_upsample: works with num_heads to set a different number</span></span>
<span id="cb8-550"><a href="#cb8-550" aria-hidden="true" tabindex="-1"></a><span class="co">                               of heads for upsampling. Deprecated.</span></span>
<span id="cb8-551"><a href="#cb8-551" aria-hidden="true" tabindex="-1"></a><span class="co">    :param use_scale_shift_norm: use a FiLM-like conditioning mechanism.</span></span>
<span id="cb8-552"><a href="#cb8-552" aria-hidden="true" tabindex="-1"></a><span class="co">    :param resblock_updown: use residual blocks for up/downsampling.</span></span>
<span id="cb8-553"><a href="#cb8-553" aria-hidden="true" tabindex="-1"></a><span class="co">    :param use_new_attention_order: use a different attention pattern for potentially</span></span>
<span id="cb8-554"><a href="#cb8-554" aria-hidden="true" tabindex="-1"></a><span class="co">                                    increased efficiency.</span></span>
<span id="cb8-555"><a href="#cb8-555" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-556"><a href="#cb8-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-557"><a href="#cb8-557" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb8-558"><a href="#cb8-558" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb8-559"><a href="#cb8-559" aria-hidden="true" tabindex="-1"></a>        image_size,</span>
<span id="cb8-560"><a href="#cb8-560" aria-hidden="true" tabindex="-1"></a>        in_channels,</span>
<span id="cb8-561"><a href="#cb8-561" aria-hidden="true" tabindex="-1"></a>        model_channels,</span>
<span id="cb8-562"><a href="#cb8-562" aria-hidden="true" tabindex="-1"></a>        out_channels,</span>
<span id="cb8-563"><a href="#cb8-563" aria-hidden="true" tabindex="-1"></a>        num_res_blocks,</span>
<span id="cb8-564"><a href="#cb8-564" aria-hidden="true" tabindex="-1"></a>        attention_resolutions,</span>
<span id="cb8-565"><a href="#cb8-565" aria-hidden="true" tabindex="-1"></a>        time_emb_factor<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb8-566"><a href="#cb8-566" aria-hidden="true" tabindex="-1"></a>        dropout<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb8-567"><a href="#cb8-567" aria-hidden="true" tabindex="-1"></a>        channel_mult<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>),</span>
<span id="cb8-568"><a href="#cb8-568" aria-hidden="true" tabindex="-1"></a>        conv_resample<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-569"><a href="#cb8-569" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb8-570"><a href="#cb8-570" aria-hidden="true" tabindex="-1"></a>        num_classes<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb8-571"><a href="#cb8-571" aria-hidden="true" tabindex="-1"></a>        use_checkpoint<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-572"><a href="#cb8-572" aria-hidden="true" tabindex="-1"></a>        use_fp16<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-573"><a href="#cb8-573" aria-hidden="true" tabindex="-1"></a>        num_heads<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb8-574"><a href="#cb8-574" aria-hidden="true" tabindex="-1"></a>        num_head_channels<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb8-575"><a href="#cb8-575" aria-hidden="true" tabindex="-1"></a>        num_heads_upsample<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb8-576"><a href="#cb8-576" aria-hidden="true" tabindex="-1"></a>        use_scale_shift_norm<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-577"><a href="#cb8-577" aria-hidden="true" tabindex="-1"></a>        resblock_updown<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-578"><a href="#cb8-578" aria-hidden="true" tabindex="-1"></a>        use_new_attention_order<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-579"><a href="#cb8-579" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb8-580"><a href="#cb8-580" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb8-581"><a href="#cb8-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-582"><a href="#cb8-582" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> num_heads_upsample <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb8-583"><a href="#cb8-583" aria-hidden="true" tabindex="-1"></a>            num_heads_upsample <span class="op">=</span> num_heads</span>
<span id="cb8-584"><a href="#cb8-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-585"><a href="#cb8-585" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_size <span class="op">=</span> image_size</span>
<span id="cb8-586"><a href="#cb8-586" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.in_channels <span class="op">=</span> in_channels</span>
<span id="cb8-587"><a href="#cb8-587" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_channels <span class="op">=</span> model_channels</span>
<span id="cb8-588"><a href="#cb8-588" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out_channels <span class="op">=</span> out_channels</span>
<span id="cb8-589"><a href="#cb8-589" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_res_blocks <span class="op">=</span> num_res_blocks</span>
<span id="cb8-590"><a href="#cb8-590" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.attention_resolutions <span class="op">=</span> attention_resolutions</span>
<span id="cb8-591"><a href="#cb8-591" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> dropout</span>
<span id="cb8-592"><a href="#cb8-592" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.channel_mult <span class="op">=</span> channel_mult</span>
<span id="cb8-593"><a href="#cb8-593" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv_resample <span class="op">=</span> conv_resample</span>
<span id="cb8-594"><a href="#cb8-594" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_classes <span class="op">=</span> num_classes</span>
<span id="cb8-595"><a href="#cb8-595" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_checkpoint <span class="op">=</span> use_checkpoint</span>
<span id="cb8-596"><a href="#cb8-596" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dtype <span class="op">=</span> th.float16 <span class="cf">if</span> use_fp16 <span class="cf">else</span> th.float32</span>
<span id="cb8-597"><a href="#cb8-597" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_heads <span class="op">=</span> num_heads</span>
<span id="cb8-598"><a href="#cb8-598" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_head_channels <span class="op">=</span> num_head_channels</span>
<span id="cb8-599"><a href="#cb8-599" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_heads_upsample <span class="op">=</span> num_heads_upsample</span>
<span id="cb8-600"><a href="#cb8-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-601"><a href="#cb8-601" aria-hidden="true" tabindex="-1"></a>        time_embed_dim <span class="op">=</span> model_channels <span class="op">*</span> time_emb_factor</span>
<span id="cb8-602"><a href="#cb8-602" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.time_embed <span class="op">=</span> nn.Sequential(</span>
<span id="cb8-603"><a href="#cb8-603" aria-hidden="true" tabindex="-1"></a>            linear(model_channels, time_embed_dim),</span>
<span id="cb8-604"><a href="#cb8-604" aria-hidden="true" tabindex="-1"></a>            nn.SiLU(),</span>
<span id="cb8-605"><a href="#cb8-605" aria-hidden="true" tabindex="-1"></a>            linear(time_embed_dim, time_embed_dim),</span>
<span id="cb8-606"><a href="#cb8-606" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-607"><a href="#cb8-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-608"><a href="#cb8-608" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.num_classes <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb8-609"><a href="#cb8-609" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.label_emb <span class="op">=</span> nn.Embedding(num_classes, time_embed_dim)</span>
<span id="cb8-610"><a href="#cb8-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-611"><a href="#cb8-611" aria-hidden="true" tabindex="-1"></a>        ch <span class="op">=</span> input_ch <span class="op">=</span> <span class="bu">int</span>(channel_mult[<span class="dv">0</span>] <span class="op">*</span> model_channels)</span>
<span id="cb8-612"><a href="#cb8-612" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.input_blocks <span class="op">=</span> nn.ModuleList(</span>
<span id="cb8-613"><a href="#cb8-613" aria-hidden="true" tabindex="-1"></a>            [TimestepEmbedSequential(conv_nd(dims, in_channels, ch, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>))]</span>
<span id="cb8-614"><a href="#cb8-614" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-615"><a href="#cb8-615" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._feature_size <span class="op">=</span> ch</span>
<span id="cb8-616"><a href="#cb8-616" aria-hidden="true" tabindex="-1"></a>        input_block_chans <span class="op">=</span> [ch]</span>
<span id="cb8-617"><a href="#cb8-617" aria-hidden="true" tabindex="-1"></a>        ds <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb8-618"><a href="#cb8-618" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> level, mult <span class="kw">in</span> <span class="bu">enumerate</span>(channel_mult):</span>
<span id="cb8-619"><a href="#cb8-619" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_res_blocks):</span>
<span id="cb8-620"><a href="#cb8-620" aria-hidden="true" tabindex="-1"></a>                layers <span class="op">=</span> [</span>
<span id="cb8-621"><a href="#cb8-621" aria-hidden="true" tabindex="-1"></a>                    ResBlock(</span>
<span id="cb8-622"><a href="#cb8-622" aria-hidden="true" tabindex="-1"></a>                        ch,</span>
<span id="cb8-623"><a href="#cb8-623" aria-hidden="true" tabindex="-1"></a>                        time_embed_dim,</span>
<span id="cb8-624"><a href="#cb8-624" aria-hidden="true" tabindex="-1"></a>                        dropout,</span>
<span id="cb8-625"><a href="#cb8-625" aria-hidden="true" tabindex="-1"></a>                        out_channels<span class="op">=</span><span class="bu">int</span>(mult <span class="op">*</span> model_channels),</span>
<span id="cb8-626"><a href="#cb8-626" aria-hidden="true" tabindex="-1"></a>                        dims<span class="op">=</span>dims,</span>
<span id="cb8-627"><a href="#cb8-627" aria-hidden="true" tabindex="-1"></a>                        use_checkpoint<span class="op">=</span>use_checkpoint,</span>
<span id="cb8-628"><a href="#cb8-628" aria-hidden="true" tabindex="-1"></a>                        use_scale_shift_norm<span class="op">=</span>use_scale_shift_norm,</span>
<span id="cb8-629"><a href="#cb8-629" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb8-630"><a href="#cb8-630" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb8-631"><a href="#cb8-631" aria-hidden="true" tabindex="-1"></a>                ch <span class="op">=</span> <span class="bu">int</span>(mult <span class="op">*</span> model_channels)</span>
<span id="cb8-632"><a href="#cb8-632" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> ds <span class="kw">in</span> attention_resolutions:</span>
<span id="cb8-633"><a href="#cb8-633" aria-hidden="true" tabindex="-1"></a>                    layers.append(</span>
<span id="cb8-634"><a href="#cb8-634" aria-hidden="true" tabindex="-1"></a>                        AttentionBlock(</span>
<span id="cb8-635"><a href="#cb8-635" aria-hidden="true" tabindex="-1"></a>                            ch,</span>
<span id="cb8-636"><a href="#cb8-636" aria-hidden="true" tabindex="-1"></a>                            use_checkpoint<span class="op">=</span>use_checkpoint,</span>
<span id="cb8-637"><a href="#cb8-637" aria-hidden="true" tabindex="-1"></a>                            num_heads<span class="op">=</span>num_heads,</span>
<span id="cb8-638"><a href="#cb8-638" aria-hidden="true" tabindex="-1"></a>                            num_head_channels<span class="op">=</span>num_head_channels,</span>
<span id="cb8-639"><a href="#cb8-639" aria-hidden="true" tabindex="-1"></a>                            use_new_attention_order<span class="op">=</span>use_new_attention_order,</span>
<span id="cb8-640"><a href="#cb8-640" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb8-641"><a href="#cb8-641" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb8-642"><a href="#cb8-642" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.input_blocks.append(TimestepEmbedSequential(<span class="op">*</span>layers))</span>
<span id="cb8-643"><a href="#cb8-643" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._feature_size <span class="op">+=</span> ch</span>
<span id="cb8-644"><a href="#cb8-644" aria-hidden="true" tabindex="-1"></a>                input_block_chans.append(ch)</span>
<span id="cb8-645"><a href="#cb8-645" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> level <span class="op">!=</span> <span class="bu">len</span>(channel_mult) <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb8-646"><a href="#cb8-646" aria-hidden="true" tabindex="-1"></a>                out_ch <span class="op">=</span> ch</span>
<span id="cb8-647"><a href="#cb8-647" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.input_blocks.append(</span>
<span id="cb8-648"><a href="#cb8-648" aria-hidden="true" tabindex="-1"></a>                    TimestepEmbedSequential(</span>
<span id="cb8-649"><a href="#cb8-649" aria-hidden="true" tabindex="-1"></a>                        ResBlock(</span>
<span id="cb8-650"><a href="#cb8-650" aria-hidden="true" tabindex="-1"></a>                            ch,</span>
<span id="cb8-651"><a href="#cb8-651" aria-hidden="true" tabindex="-1"></a>                            time_embed_dim,</span>
<span id="cb8-652"><a href="#cb8-652" aria-hidden="true" tabindex="-1"></a>                            dropout,</span>
<span id="cb8-653"><a href="#cb8-653" aria-hidden="true" tabindex="-1"></a>                            out_channels<span class="op">=</span>out_ch,</span>
<span id="cb8-654"><a href="#cb8-654" aria-hidden="true" tabindex="-1"></a>                            dims<span class="op">=</span>dims,</span>
<span id="cb8-655"><a href="#cb8-655" aria-hidden="true" tabindex="-1"></a>                            use_checkpoint<span class="op">=</span>use_checkpoint,</span>
<span id="cb8-656"><a href="#cb8-656" aria-hidden="true" tabindex="-1"></a>                            use_scale_shift_norm<span class="op">=</span>use_scale_shift_norm,</span>
<span id="cb8-657"><a href="#cb8-657" aria-hidden="true" tabindex="-1"></a>                            down<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-658"><a href="#cb8-658" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb8-659"><a href="#cb8-659" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> resblock_updown</span>
<span id="cb8-660"><a href="#cb8-660" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span> Downsample(</span>
<span id="cb8-661"><a href="#cb8-661" aria-hidden="true" tabindex="-1"></a>                            ch, conv_resample, dims<span class="op">=</span>dims, out_channels<span class="op">=</span>out_ch</span>
<span id="cb8-662"><a href="#cb8-662" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb8-663"><a href="#cb8-663" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb8-664"><a href="#cb8-664" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb8-665"><a href="#cb8-665" aria-hidden="true" tabindex="-1"></a>                ch <span class="op">=</span> out_ch</span>
<span id="cb8-666"><a href="#cb8-666" aria-hidden="true" tabindex="-1"></a>                input_block_chans.append(ch)</span>
<span id="cb8-667"><a href="#cb8-667" aria-hidden="true" tabindex="-1"></a>                ds <span class="op">*=</span> <span class="dv">2</span></span>
<span id="cb8-668"><a href="#cb8-668" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._feature_size <span class="op">+=</span> ch</span>
<span id="cb8-669"><a href="#cb8-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-670"><a href="#cb8-670" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.middle_block <span class="op">=</span> TimestepEmbedSequential(</span>
<span id="cb8-671"><a href="#cb8-671" aria-hidden="true" tabindex="-1"></a>            ResBlock(</span>
<span id="cb8-672"><a href="#cb8-672" aria-hidden="true" tabindex="-1"></a>                ch,</span>
<span id="cb8-673"><a href="#cb8-673" aria-hidden="true" tabindex="-1"></a>                time_embed_dim,</span>
<span id="cb8-674"><a href="#cb8-674" aria-hidden="true" tabindex="-1"></a>                dropout,</span>
<span id="cb8-675"><a href="#cb8-675" aria-hidden="true" tabindex="-1"></a>                dims<span class="op">=</span>dims,</span>
<span id="cb8-676"><a href="#cb8-676" aria-hidden="true" tabindex="-1"></a>                use_checkpoint<span class="op">=</span>use_checkpoint,</span>
<span id="cb8-677"><a href="#cb8-677" aria-hidden="true" tabindex="-1"></a>                use_scale_shift_norm<span class="op">=</span>use_scale_shift_norm,</span>
<span id="cb8-678"><a href="#cb8-678" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb8-679"><a href="#cb8-679" aria-hidden="true" tabindex="-1"></a>            AttentionBlock(</span>
<span id="cb8-680"><a href="#cb8-680" aria-hidden="true" tabindex="-1"></a>                ch,</span>
<span id="cb8-681"><a href="#cb8-681" aria-hidden="true" tabindex="-1"></a>                use_checkpoint<span class="op">=</span>use_checkpoint,</span>
<span id="cb8-682"><a href="#cb8-682" aria-hidden="true" tabindex="-1"></a>                num_heads<span class="op">=</span>num_heads,</span>
<span id="cb8-683"><a href="#cb8-683" aria-hidden="true" tabindex="-1"></a>                num_head_channels<span class="op">=</span>num_head_channels,</span>
<span id="cb8-684"><a href="#cb8-684" aria-hidden="true" tabindex="-1"></a>                use_new_attention_order<span class="op">=</span>use_new_attention_order,</span>
<span id="cb8-685"><a href="#cb8-685" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb8-686"><a href="#cb8-686" aria-hidden="true" tabindex="-1"></a>            ResBlock(</span>
<span id="cb8-687"><a href="#cb8-687" aria-hidden="true" tabindex="-1"></a>                ch,</span>
<span id="cb8-688"><a href="#cb8-688" aria-hidden="true" tabindex="-1"></a>                time_embed_dim,</span>
<span id="cb8-689"><a href="#cb8-689" aria-hidden="true" tabindex="-1"></a>                dropout,</span>
<span id="cb8-690"><a href="#cb8-690" aria-hidden="true" tabindex="-1"></a>                dims<span class="op">=</span>dims,</span>
<span id="cb8-691"><a href="#cb8-691" aria-hidden="true" tabindex="-1"></a>                use_checkpoint<span class="op">=</span>use_checkpoint,</span>
<span id="cb8-692"><a href="#cb8-692" aria-hidden="true" tabindex="-1"></a>                use_scale_shift_norm<span class="op">=</span>use_scale_shift_norm,</span>
<span id="cb8-693"><a href="#cb8-693" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb8-694"><a href="#cb8-694" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-695"><a href="#cb8-695" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._feature_size <span class="op">+=</span> ch</span>
<span id="cb8-696"><a href="#cb8-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-697"><a href="#cb8-697" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_blocks <span class="op">=</span> nn.ModuleList([])</span>
<span id="cb8-698"><a href="#cb8-698" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> level, mult <span class="kw">in</span> <span class="bu">list</span>(<span class="bu">enumerate</span>(channel_mult))[::<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb8-699"><a href="#cb8-699" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_res_blocks <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb8-700"><a href="#cb8-700" aria-hidden="true" tabindex="-1"></a>                ich <span class="op">=</span> input_block_chans.pop()</span>
<span id="cb8-701"><a href="#cb8-701" aria-hidden="true" tabindex="-1"></a>                layers <span class="op">=</span> [</span>
<span id="cb8-702"><a href="#cb8-702" aria-hidden="true" tabindex="-1"></a>                    ResBlock(</span>
<span id="cb8-703"><a href="#cb8-703" aria-hidden="true" tabindex="-1"></a>                        ch <span class="op">+</span> ich,</span>
<span id="cb8-704"><a href="#cb8-704" aria-hidden="true" tabindex="-1"></a>                        time_embed_dim,</span>
<span id="cb8-705"><a href="#cb8-705" aria-hidden="true" tabindex="-1"></a>                        dropout,</span>
<span id="cb8-706"><a href="#cb8-706" aria-hidden="true" tabindex="-1"></a>                        out_channels<span class="op">=</span><span class="bu">int</span>(model_channels <span class="op">*</span> mult),</span>
<span id="cb8-707"><a href="#cb8-707" aria-hidden="true" tabindex="-1"></a>                        dims<span class="op">=</span>dims,</span>
<span id="cb8-708"><a href="#cb8-708" aria-hidden="true" tabindex="-1"></a>                        use_checkpoint<span class="op">=</span>use_checkpoint,</span>
<span id="cb8-709"><a href="#cb8-709" aria-hidden="true" tabindex="-1"></a>                        use_scale_shift_norm<span class="op">=</span>use_scale_shift_norm,</span>
<span id="cb8-710"><a href="#cb8-710" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb8-711"><a href="#cb8-711" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb8-712"><a href="#cb8-712" aria-hidden="true" tabindex="-1"></a>                ch <span class="op">=</span> <span class="bu">int</span>(model_channels <span class="op">*</span> mult)</span>
<span id="cb8-713"><a href="#cb8-713" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> ds <span class="kw">in</span> attention_resolutions:</span>
<span id="cb8-714"><a href="#cb8-714" aria-hidden="true" tabindex="-1"></a>                    layers.append(</span>
<span id="cb8-715"><a href="#cb8-715" aria-hidden="true" tabindex="-1"></a>                        AttentionBlock(</span>
<span id="cb8-716"><a href="#cb8-716" aria-hidden="true" tabindex="-1"></a>                            ch,</span>
<span id="cb8-717"><a href="#cb8-717" aria-hidden="true" tabindex="-1"></a>                            use_checkpoint<span class="op">=</span>use_checkpoint,</span>
<span id="cb8-718"><a href="#cb8-718" aria-hidden="true" tabindex="-1"></a>                            num_heads<span class="op">=</span>num_heads_upsample,</span>
<span id="cb8-719"><a href="#cb8-719" aria-hidden="true" tabindex="-1"></a>                            num_head_channels<span class="op">=</span>num_head_channels,</span>
<span id="cb8-720"><a href="#cb8-720" aria-hidden="true" tabindex="-1"></a>                            use_new_attention_order<span class="op">=</span>use_new_attention_order,</span>
<span id="cb8-721"><a href="#cb8-721" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb8-722"><a href="#cb8-722" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb8-723"><a href="#cb8-723" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> level <span class="kw">and</span> i <span class="op">==</span> num_res_blocks:</span>
<span id="cb8-724"><a href="#cb8-724" aria-hidden="true" tabindex="-1"></a>                    out_ch <span class="op">=</span> ch</span>
<span id="cb8-725"><a href="#cb8-725" aria-hidden="true" tabindex="-1"></a>                    layers.append(</span>
<span id="cb8-726"><a href="#cb8-726" aria-hidden="true" tabindex="-1"></a>                        ResBlock(</span>
<span id="cb8-727"><a href="#cb8-727" aria-hidden="true" tabindex="-1"></a>                            ch,</span>
<span id="cb8-728"><a href="#cb8-728" aria-hidden="true" tabindex="-1"></a>                            time_embed_dim,</span>
<span id="cb8-729"><a href="#cb8-729" aria-hidden="true" tabindex="-1"></a>                            dropout,</span>
<span id="cb8-730"><a href="#cb8-730" aria-hidden="true" tabindex="-1"></a>                            out_channels<span class="op">=</span>out_ch,</span>
<span id="cb8-731"><a href="#cb8-731" aria-hidden="true" tabindex="-1"></a>                            dims<span class="op">=</span>dims,</span>
<span id="cb8-732"><a href="#cb8-732" aria-hidden="true" tabindex="-1"></a>                            use_checkpoint<span class="op">=</span>use_checkpoint,</span>
<span id="cb8-733"><a href="#cb8-733" aria-hidden="true" tabindex="-1"></a>                            use_scale_shift_norm<span class="op">=</span>use_scale_shift_norm,</span>
<span id="cb8-734"><a href="#cb8-734" aria-hidden="true" tabindex="-1"></a>                            up<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-735"><a href="#cb8-735" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb8-736"><a href="#cb8-736" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> resblock_updown</span>
<span id="cb8-737"><a href="#cb8-737" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span> Upsample(ch, conv_resample, dims<span class="op">=</span>dims, out_channels<span class="op">=</span>out_ch)</span>
<span id="cb8-738"><a href="#cb8-738" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb8-739"><a href="#cb8-739" aria-hidden="true" tabindex="-1"></a>                    ds <span class="op">//=</span> <span class="dv">2</span></span>
<span id="cb8-740"><a href="#cb8-740" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.output_blocks.append(TimestepEmbedSequential(<span class="op">*</span>layers))</span>
<span id="cb8-741"><a href="#cb8-741" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._feature_size <span class="op">+=</span> ch</span>
<span id="cb8-742"><a href="#cb8-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-743"><a href="#cb8-743" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out <span class="op">=</span> nn.Sequential(</span>
<span id="cb8-744"><a href="#cb8-744" aria-hidden="true" tabindex="-1"></a>            normalization(ch),</span>
<span id="cb8-745"><a href="#cb8-745" aria-hidden="true" tabindex="-1"></a>            nn.SiLU(),</span>
<span id="cb8-746"><a href="#cb8-746" aria-hidden="true" tabindex="-1"></a>            zero_module(conv_nd(dims, input_ch, out_channels, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>)),</span>
<span id="cb8-747"><a href="#cb8-747" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-748"><a href="#cb8-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-749"><a href="#cb8-749" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, t, x, y<span class="op">=</span><span class="va">None</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb8-750"><a href="#cb8-750" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb8-751"><a href="#cb8-751" aria-hidden="true" tabindex="-1"></a><span class="co">        Apply the model to an input batch.</span></span>
<span id="cb8-752"><a href="#cb8-752" aria-hidden="true" tabindex="-1"></a><span class="co">        :param t: a 1-D batch of timesteps.</span></span>
<span id="cb8-753"><a href="#cb8-753" aria-hidden="true" tabindex="-1"></a><span class="co">        :param x: an [N x C x ...] Tensor of inputs.</span></span>
<span id="cb8-754"><a href="#cb8-754" aria-hidden="true" tabindex="-1"></a><span class="co">        :param y: an [N] Tensor of labels, if class-conditional.</span></span>
<span id="cb8-755"><a href="#cb8-755" aria-hidden="true" tabindex="-1"></a><span class="co">        :return: an [N x C x ...] Tensor of outputs.</span></span>
<span id="cb8-756"><a href="#cb8-756" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb8-757"><a href="#cb8-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-758"><a href="#cb8-758" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> (y <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>) <span class="op">==</span> (</span>
<span id="cb8-759"><a href="#cb8-759" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.num_classes <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb8-760"><a href="#cb8-760" aria-hidden="true" tabindex="-1"></a>        ), <span class="st">"must specify y if and only if the model is class-conditional"</span></span>
<span id="cb8-761"><a href="#cb8-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-762"><a href="#cb8-762" aria-hidden="true" tabindex="-1"></a>        hs <span class="op">=</span> []</span>
<span id="cb8-763"><a href="#cb8-763" aria-hidden="true" tabindex="-1"></a>        emb <span class="op">=</span> <span class="va">self</span>.time_embed(timestep_embedding(t, <span class="va">self</span>.model_channels))</span>
<span id="cb8-764"><a href="#cb8-764" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.num_classes <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb8-765"><a href="#cb8-765" aria-hidden="true" tabindex="-1"></a>            <span class="cf">assert</span> y.shape <span class="op">==</span> (x.shape[<span class="dv">0</span>],)</span>
<span id="cb8-766"><a href="#cb8-766" aria-hidden="true" tabindex="-1"></a>            emb <span class="op">=</span> emb <span class="op">+</span> <span class="va">self</span>.label_emb(y)</span>
<span id="cb8-767"><a href="#cb8-767" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> x.<span class="bu">type</span>(<span class="va">self</span>.dtype)</span>
<span id="cb8-768"><a href="#cb8-768" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> module <span class="kw">in</span> <span class="va">self</span>.input_blocks:</span>
<span id="cb8-769"><a href="#cb8-769" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> module(h, emb)</span>
<span id="cb8-770"><a href="#cb8-770" aria-hidden="true" tabindex="-1"></a>            hs.append(h)</span>
<span id="cb8-771"><a href="#cb8-771" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> <span class="va">self</span>.middle_block(h, emb)</span>
<span id="cb8-772"><a href="#cb8-772" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> module <span class="kw">in</span> <span class="va">self</span>.output_blocks:</span>
<span id="cb8-773"><a href="#cb8-773" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> th.cat([h, hs.pop()], dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-774"><a href="#cb8-774" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> module(h, emb)</span>
<span id="cb8-775"><a href="#cb8-775" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> h.<span class="bu">type</span>(x.dtype)</span>
<span id="cb8-776"><a href="#cb8-776" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.out(h)</span>
<span id="cb8-777"><a href="#cb8-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-778"><a href="#cb8-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-779"><a href="#cb8-779" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> UNetBig(</span>
<span id="cb8-780"><a href="#cb8-780" aria-hidden="true" tabindex="-1"></a>    image_size,</span>
<span id="cb8-781"><a href="#cb8-781" aria-hidden="true" tabindex="-1"></a>    in_channels<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb8-782"><a href="#cb8-782" aria-hidden="true" tabindex="-1"></a>    out_channels<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb8-783"><a href="#cb8-783" aria-hidden="true" tabindex="-1"></a>    base_width<span class="op">=</span><span class="dv">192</span>,</span>
<span id="cb8-784"><a href="#cb8-784" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb8-785"><a href="#cb8-785" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb8-786"><a href="#cb8-786" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> image_size <span class="op">==</span> <span class="dv">128</span>:</span>
<span id="cb8-787"><a href="#cb8-787" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb8-788"><a href="#cb8-788" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> image_size <span class="op">==</span> <span class="dv">64</span>:</span>
<span id="cb8-789"><a href="#cb8-789" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb8-790"><a href="#cb8-790" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> image_size <span class="op">==</span> <span class="dv">32</span>:</span>
<span id="cb8-791"><a href="#cb8-791" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb8-792"><a href="#cb8-792" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> image_size <span class="op">==</span> <span class="dv">28</span>:</span>
<span id="cb8-793"><a href="#cb8-793" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb8-794"><a href="#cb8-794" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-795"><a href="#cb8-795" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"unsupported image size: </span><span class="sc">{</span>image_size<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-796"><a href="#cb8-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-797"><a href="#cb8-797" aria-hidden="true" tabindex="-1"></a>    attention_ds <span class="op">=</span> []</span>
<span id="cb8-798"><a href="#cb8-798" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> image_size <span class="op">==</span> <span class="dv">28</span>:</span>
<span id="cb8-799"><a href="#cb8-799" aria-hidden="true" tabindex="-1"></a>        attention_resolutions <span class="op">=</span> <span class="st">"28,14,7"</span></span>
<span id="cb8-800"><a href="#cb8-800" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-801"><a href="#cb8-801" aria-hidden="true" tabindex="-1"></a>        attention_resolutions <span class="op">=</span> <span class="st">"32,16,8"</span></span>
<span id="cb8-802"><a href="#cb8-802" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> res <span class="kw">in</span> attention_resolutions.split(<span class="st">","</span>):</span>
<span id="cb8-803"><a href="#cb8-803" aria-hidden="true" tabindex="-1"></a>        attention_ds.append(image_size <span class="op">//</span> <span class="bu">int</span>(res))</span>
<span id="cb8-804"><a href="#cb8-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-805"><a href="#cb8-805" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> UNetModel(</span>
<span id="cb8-806"><a href="#cb8-806" aria-hidden="true" tabindex="-1"></a>        image_size<span class="op">=</span>image_size,</span>
<span id="cb8-807"><a href="#cb8-807" aria-hidden="true" tabindex="-1"></a>        in_channels<span class="op">=</span>in_channels,</span>
<span id="cb8-808"><a href="#cb8-808" aria-hidden="true" tabindex="-1"></a>        model_channels<span class="op">=</span>base_width,</span>
<span id="cb8-809"><a href="#cb8-809" aria-hidden="true" tabindex="-1"></a>        out_channels<span class="op">=</span>out_channels,</span>
<span id="cb8-810"><a href="#cb8-810" aria-hidden="true" tabindex="-1"></a>        num_res_blocks<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb8-811"><a href="#cb8-811" aria-hidden="true" tabindex="-1"></a>        attention_resolutions<span class="op">=</span><span class="bu">tuple</span>(attention_ds),</span>
<span id="cb8-812"><a href="#cb8-812" aria-hidden="true" tabindex="-1"></a>        dropout<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb8-813"><a href="#cb8-813" aria-hidden="true" tabindex="-1"></a>        channel_mult<span class="op">=</span>channel_mult,</span>
<span id="cb8-814"><a href="#cb8-814" aria-hidden="true" tabindex="-1"></a>        num_classes<span class="op">=</span>num_classes,</span>
<span id="cb8-815"><a href="#cb8-815" aria-hidden="true" tabindex="-1"></a>        use_checkpoint<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-816"><a href="#cb8-816" aria-hidden="true" tabindex="-1"></a>        use_fp16<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-817"><a href="#cb8-817" aria-hidden="true" tabindex="-1"></a>        num_heads<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb8-818"><a href="#cb8-818" aria-hidden="true" tabindex="-1"></a>        num_head_channels<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb8-819"><a href="#cb8-819" aria-hidden="true" tabindex="-1"></a>        num_heads_upsample<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb8-820"><a href="#cb8-820" aria-hidden="true" tabindex="-1"></a>        use_scale_shift_norm<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-821"><a href="#cb8-821" aria-hidden="true" tabindex="-1"></a>        resblock_updown<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-822"><a href="#cb8-822" aria-hidden="true" tabindex="-1"></a>        use_new_attention_order<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-823"><a href="#cb8-823" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-824"><a href="#cb8-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-825"><a href="#cb8-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-826"><a href="#cb8-826" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> UNet(</span>
<span id="cb8-827"><a href="#cb8-827" aria-hidden="true" tabindex="-1"></a>    image_size,</span>
<span id="cb8-828"><a href="#cb8-828" aria-hidden="true" tabindex="-1"></a>    in_channels<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb8-829"><a href="#cb8-829" aria-hidden="true" tabindex="-1"></a>    out_channels<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb8-830"><a href="#cb8-830" aria-hidden="true" tabindex="-1"></a>    base_width<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb8-831"><a href="#cb8-831" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb8-832"><a href="#cb8-832" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb8-833"><a href="#cb8-833" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> image_size <span class="op">==</span> <span class="dv">128</span>:</span>
<span id="cb8-834"><a href="#cb8-834" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb8-835"><a href="#cb8-835" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> image_size <span class="op">==</span> <span class="dv">64</span>:</span>
<span id="cb8-836"><a href="#cb8-836" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb8-837"><a href="#cb8-837" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> image_size <span class="op">==</span> <span class="dv">32</span>:</span>
<span id="cb8-838"><a href="#cb8-838" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb8-839"><a href="#cb8-839" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> image_size <span class="op">==</span> <span class="dv">28</span>:</span>
<span id="cb8-840"><a href="#cb8-840" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb8-841"><a href="#cb8-841" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-842"><a href="#cb8-842" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"unsupported image size: </span><span class="sc">{</span>image_size<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-843"><a href="#cb8-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-844"><a href="#cb8-844" aria-hidden="true" tabindex="-1"></a>    attention_ds <span class="op">=</span> []</span>
<span id="cb8-845"><a href="#cb8-845" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> image_size <span class="op">==</span> <span class="dv">28</span>:</span>
<span id="cb8-846"><a href="#cb8-846" aria-hidden="true" tabindex="-1"></a>        attention_resolutions <span class="op">=</span> <span class="st">"28,14,7"</span></span>
<span id="cb8-847"><a href="#cb8-847" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-848"><a href="#cb8-848" aria-hidden="true" tabindex="-1"></a>        attention_resolutions <span class="op">=</span> <span class="st">"32,16,8"</span></span>
<span id="cb8-849"><a href="#cb8-849" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> res <span class="kw">in</span> attention_resolutions.split(<span class="st">","</span>):</span>
<span id="cb8-850"><a href="#cb8-850" aria-hidden="true" tabindex="-1"></a>        attention_ds.append(image_size <span class="op">//</span> <span class="bu">int</span>(res))</span>
<span id="cb8-851"><a href="#cb8-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-852"><a href="#cb8-852" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> UNetModel(</span>
<span id="cb8-853"><a href="#cb8-853" aria-hidden="true" tabindex="-1"></a>        image_size<span class="op">=</span>image_size,</span>
<span id="cb8-854"><a href="#cb8-854" aria-hidden="true" tabindex="-1"></a>        in_channels<span class="op">=</span>in_channels,</span>
<span id="cb8-855"><a href="#cb8-855" aria-hidden="true" tabindex="-1"></a>        model_channels<span class="op">=</span>base_width,</span>
<span id="cb8-856"><a href="#cb8-856" aria-hidden="true" tabindex="-1"></a>        out_channels<span class="op">=</span>out_channels,</span>
<span id="cb8-857"><a href="#cb8-857" aria-hidden="true" tabindex="-1"></a>        num_res_blocks<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb8-858"><a href="#cb8-858" aria-hidden="true" tabindex="-1"></a>        attention_resolutions<span class="op">=</span><span class="bu">tuple</span>(attention_ds),</span>
<span id="cb8-859"><a href="#cb8-859" aria-hidden="true" tabindex="-1"></a>        dropout<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb8-860"><a href="#cb8-860" aria-hidden="true" tabindex="-1"></a>        channel_mult<span class="op">=</span>channel_mult,</span>
<span id="cb8-861"><a href="#cb8-861" aria-hidden="true" tabindex="-1"></a>        num_classes<span class="op">=</span>num_classes,</span>
<span id="cb8-862"><a href="#cb8-862" aria-hidden="true" tabindex="-1"></a>        use_checkpoint<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-863"><a href="#cb8-863" aria-hidden="true" tabindex="-1"></a>        use_fp16<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-864"><a href="#cb8-864" aria-hidden="true" tabindex="-1"></a>        num_heads<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb8-865"><a href="#cb8-865" aria-hidden="true" tabindex="-1"></a>        num_head_channels<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb8-866"><a href="#cb8-866" aria-hidden="true" tabindex="-1"></a>        num_heads_upsample<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb8-867"><a href="#cb8-867" aria-hidden="true" tabindex="-1"></a>        use_scale_shift_norm<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-868"><a href="#cb8-868" aria-hidden="true" tabindex="-1"></a>        resblock_updown<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-869"><a href="#cb8-869" aria-hidden="true" tabindex="-1"></a>        use_new_attention_order<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-870"><a href="#cb8-870" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-871"><a href="#cb8-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-872"><a href="#cb8-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-873"><a href="#cb8-873" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> UNetSmall(</span>
<span id="cb8-874"><a href="#cb8-874" aria-hidden="true" tabindex="-1"></a>    image_size,</span>
<span id="cb8-875"><a href="#cb8-875" aria-hidden="true" tabindex="-1"></a>    in_channels<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb8-876"><a href="#cb8-876" aria-hidden="true" tabindex="-1"></a>    out_channels<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb8-877"><a href="#cb8-877" aria-hidden="true" tabindex="-1"></a>    base_width<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb8-878"><a href="#cb8-878" aria-hidden="true" tabindex="-1"></a>    num_classes<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb8-879"><a href="#cb8-879" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb8-880"><a href="#cb8-880" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> image_size <span class="op">==</span> <span class="dv">128</span>:</span>
<span id="cb8-881"><a href="#cb8-881" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb8-882"><a href="#cb8-882" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> image_size <span class="op">==</span> <span class="dv">64</span>:</span>
<span id="cb8-883"><a href="#cb8-883" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb8-884"><a href="#cb8-884" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> image_size <span class="op">==</span> <span class="dv">32</span>:</span>
<span id="cb8-885"><a href="#cb8-885" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb8-886"><a href="#cb8-886" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> image_size <span class="op">==</span> <span class="dv">28</span>:</span>
<span id="cb8-887"><a href="#cb8-887" aria-hidden="true" tabindex="-1"></a>        channel_mult <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb8-888"><a href="#cb8-888" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-889"><a href="#cb8-889" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"unsupported image size: </span><span class="sc">{</span>image_size<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-890"><a href="#cb8-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-891"><a href="#cb8-891" aria-hidden="true" tabindex="-1"></a>    attention_ds <span class="op">=</span> []</span>
<span id="cb8-892"><a href="#cb8-892" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> image_size <span class="op">==</span> <span class="dv">28</span>:</span>
<span id="cb8-893"><a href="#cb8-893" aria-hidden="true" tabindex="-1"></a>        attention_resolutions <span class="op">=</span> <span class="st">"28,14,7"</span></span>
<span id="cb8-894"><a href="#cb8-894" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-895"><a href="#cb8-895" aria-hidden="true" tabindex="-1"></a>        attention_resolutions <span class="op">=</span> <span class="st">"32,16,8"</span></span>
<span id="cb8-896"><a href="#cb8-896" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> res <span class="kw">in</span> attention_resolutions.split(<span class="st">","</span>):</span>
<span id="cb8-897"><a href="#cb8-897" aria-hidden="true" tabindex="-1"></a>        attention_ds.append(image_size <span class="op">//</span> <span class="bu">int</span>(res))</span>
<span id="cb8-898"><a href="#cb8-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-899"><a href="#cb8-899" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> UNetModel(</span>
<span id="cb8-900"><a href="#cb8-900" aria-hidden="true" tabindex="-1"></a>        image_size<span class="op">=</span>image_size,</span>
<span id="cb8-901"><a href="#cb8-901" aria-hidden="true" tabindex="-1"></a>        in_channels<span class="op">=</span>in_channels,</span>
<span id="cb8-902"><a href="#cb8-902" aria-hidden="true" tabindex="-1"></a>        model_channels<span class="op">=</span>base_width,</span>
<span id="cb8-903"><a href="#cb8-903" aria-hidden="true" tabindex="-1"></a>        out_channels<span class="op">=</span>out_channels,</span>
<span id="cb8-904"><a href="#cb8-904" aria-hidden="true" tabindex="-1"></a>        num_res_blocks<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb8-905"><a href="#cb8-905" aria-hidden="true" tabindex="-1"></a>        attention_resolutions<span class="op">=</span><span class="bu">tuple</span>(attention_ds),</span>
<span id="cb8-906"><a href="#cb8-906" aria-hidden="true" tabindex="-1"></a>        time_emb_factor<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb8-907"><a href="#cb8-907" aria-hidden="true" tabindex="-1"></a>        dropout<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb8-908"><a href="#cb8-908" aria-hidden="true" tabindex="-1"></a>        channel_mult<span class="op">=</span>channel_mult,</span>
<span id="cb8-909"><a href="#cb8-909" aria-hidden="true" tabindex="-1"></a>        num_classes<span class="op">=</span>num_classes,</span>
<span id="cb8-910"><a href="#cb8-910" aria-hidden="true" tabindex="-1"></a>        use_checkpoint<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-911"><a href="#cb8-911" aria-hidden="true" tabindex="-1"></a>        use_fp16<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-912"><a href="#cb8-912" aria-hidden="true" tabindex="-1"></a>        num_heads<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb8-913"><a href="#cb8-913" aria-hidden="true" tabindex="-1"></a>        num_head_channels<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb8-914"><a href="#cb8-914" aria-hidden="true" tabindex="-1"></a>        num_heads_upsample<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb8-915"><a href="#cb8-915" aria-hidden="true" tabindex="-1"></a>        use_scale_shift_norm<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-916"><a href="#cb8-916" aria-hidden="true" tabindex="-1"></a>        resblock_updown<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-917"><a href="#cb8-917" aria-hidden="true" tabindex="-1"></a>        use_new_attention_order<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-918"><a href="#cb8-918" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-model-the-user-logic" class="level3">
<h3 class="anchored" data-anchor-id="create-model-the-user-logic">Create model (the user logic)</h3>
<div id="74f451b7" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:16.925379Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:16.925059Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:17.538815Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:17.538406Z&quot;}" data-outputid="135b45ea-0a39-4376-ec4e-84370866d498" data-papermill="{&quot;duration&quot;:0.634562,&quot;end_time&quot;:&quot;2025-02-18T03:35:17.539649&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:16.905087&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">"cuda"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>denoising_model <span class="op">=</span> UNet(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    image_size<span class="op">=</span>config.resolution,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>).to(device)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"model params: </span><span class="sc">{</span><span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> denoising_model.parameters()) <span class="op">/</span> <span class="fl">1e6</span><span class="sc">:.2f}</span><span class="ss"> M"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>model params: 32.85 M</code></pre>
</div>
</div>
</section>
<section id="optimizer" class="level3">
<h3 class="anchored" data-anchor-id="optimizer">Optimizer</h3>
<div id="8ff69639" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:17.615708Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:17.615377Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:17.634145Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:17.633755Z&quot;}" data-papermill="{&quot;duration&quot;:0.038874,&quot;end_time&quot;:&quot;2025-02-18T03:35:17.635102&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:17.596228&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> optim.AdamW(denoising_model.parameters(), lr<span class="op">=</span>config.learning_rate, weight_decay<span class="op">=</span>config.weight_decay)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="train" class="level2">
<h2 class="anchored" data-anchor-id="train">Train</h2>
<section id="forward-diffusion" class="level3">
<h3 class="anchored" data-anchor-id="forward-diffusion">Forward diffusion</h3>
<p>Forward diffusion can be considered as “data augmentation” in the training step. It adds noise to the data to challenge the model to be able to tell apart signal from noise. Diffusion is a particular way of adding noise, with a carefully designed noise schedule.</p>
<p>The forward diffusion defines a sequence of images:</p>
<p><span class="math display">\[x_0, x_1, x_2, ..., x_T\]</span></p>
<p>where T is the number of diffusion steps (e.g.&nbsp;1000).</p>
<p>Similar to an algebraic sequence with a common difference, the diffusion sequence has a common noise <span class="math inline">\(\mathbf\epsilon\)</span>. The recursive formula is:</p>
<p><span class="math display">\[
x_t = \sqrt{\alpha_t} x_{t-1} + \sqrt{\beta_t} \mathbf\epsilon
\]</span></p>
<p>where <span class="math inline">\(\beta_t = 1 - \alpha_t\)</span> is the variance of the noise at time <span class="math inline">\(t\)</span>. This relationship is primarily a design choice that simplifies the mathematics and makes the derivations more elegant and manageable.</p>
<p>One can then derive the explicit formula for <span class="math inline">\(x_t\)</span> expressed in terms of <span class="math inline">\(x_0\)</span> and <span class="math inline">\(\mathbf\epsilon\)</span>:</p>
<p><span class="math display">\[
x_t = \sqrt{\bar\alpha_t} x_0 + \sqrt{1 - \bar\alpha_t} \mathbf\epsilon
\]</span></p>
<p>where <span class="math inline">\(\bar\alpha_t = \prod_{i=1}^t \alpha_i\)</span> is the cumulative product of the variance of the noise at time <span class="math inline">\(t\)</span>.</p>
<p>The forward diffusion process is thus defined by this noise schedule: <span class="math inline">\(\beta_1, \beta_2, ..., \beta_T\)</span>.</p>
<div id="c6ba8381" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:17.747242Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:17.746780Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:17.766063Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:17.765635Z&quot;}" data-papermill="{&quot;duration&quot;:0.04031,&quot;end_time&quot;:&quot;2025-02-18T03:35:17.767153&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:17.726843&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward_diffusion(x_0, t, noise_schedule, noise<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    _ts <span class="op">=</span> t.view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> noise <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        noise <span class="op">=</span> torch.randn_like(x_0)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> _ts.<span class="bu">max</span>() <span class="op">&lt;</span> <span class="bu">len</span>(noise_schedule[<span class="st">"alphas_cumprod"</span>]), <span class="ss">f"t=</span><span class="sc">{</span>_ts<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss"> is larger than the length of noise_schedule: </span><span class="sc">{</span><span class="bu">len</span>(noise_schedule[<span class="st">'alphas_cumprod'</span>])<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    alpha_prod_t <span class="op">=</span> noise_schedule[<span class="st">"alphas_cumprod"</span>][_ts]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    x_t <span class="op">=</span> (alpha_prod_t <span class="op">**</span> <span class="fl">0.5</span>) <span class="op">*</span> x_0 <span class="op">+</span> ((<span class="dv">1</span> <span class="op">-</span> alpha_prod_t) <span class="op">**</span> <span class="fl">0.5</span>) <span class="op">*</span> noise</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_t, noise</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="noise-schedule" class="level4">
<h4 class="anchored" data-anchor-id="noise-schedule">Noise schedule</h4>
<p>The range of <span class="math inline">\(\beta_t\)</span> is empirically chosen to be between 1e-4 and 0.02. We can plot the noise schedule curves to visualize the blending ratio between the clean data and the noise, and how it changes over “time” through the diffusion process.</p>
<div id="35cefe30" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:17.844580Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:17.844141Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:18.118802Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:18.118406Z&quot;}" data-papermill="{&quot;duration&quot;:0.295227,&quot;end_time&quot;:&quot;2025-02-18T03:35:18.119717&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:17.824490&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>beta_min, beta_max <span class="op">=</span> <span class="fl">1e-4</span>, <span class="fl">0.02</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_noise_schedule(n_T: <span class="bu">int</span>, device: torch.device) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, torch.Tensor]:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    betas <span class="op">=</span> torch.linspace(beta_min, beta_max, n_T).to(device)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    alphas <span class="op">=</span> <span class="fl">1.</span> <span class="op">-</span> betas</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    alphas_cumprod <span class="op">=</span> torch.cumprod(alphas, axis<span class="op">=</span><span class="dv">0</span>).to(device)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    alphas_cumprod_prev <span class="op">=</span> torch.cat([torch.ones(<span class="dv">1</span>).to(device), alphas_cumprod[:<span class="op">-</span><span class="dv">1</span>].to(device)])</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    sqrt_recip_alphas <span class="op">=</span> torch.sqrt(<span class="fl">1.0</span> <span class="op">/</span> alphas).to(device)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    sqrt_alphas_cumprod <span class="op">=</span> torch.sqrt(alphas_cumprod).to(device)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    sqrt_one_minus_alphas_cumprod <span class="op">=</span> torch.sqrt(<span class="fl">1.</span> <span class="op">-</span> alphas_cumprod)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    posterior_variance <span class="op">=</span> betas <span class="op">*</span> (<span class="fl">1.</span> <span class="op">-</span> alphas_cumprod_prev) <span class="op">/</span> (<span class="fl">1.</span> <span class="op">-</span> alphas_cumprod)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"betas"</span>: betas,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"alphas"</span>: alphas,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"alphas_cumprod"</span>: alphas_cumprod,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sqrt_recip_alphas"</span>: sqrt_recip_alphas,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sqrt_alphas_cumprod"</span>: sqrt_alphas_cumprod,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sqrt_one_minus_alphas_cumprod"</span>: sqrt_one_minus_alphas_cumprod,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"posterior_variance"</span>: posterior_variance,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>noise_schedule <span class="op">=</span> create_noise_schedule(config.num_denoising_steps, device)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the schedule</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">3</span>))</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)<span class="op">;</span> plt.plot(<span class="bu">range</span>(<span class="dv">1000</span>), noise_schedule[<span class="st">"sqrt_alphas_cumprod"</span>].cpu().numpy())</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r"$\sqrt{\bar\alpha_t}$: signal level"</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)<span class="op">;</span> plt.plot(<span class="bu">range</span>(<span class="dv">1000</span>), noise_schedule[<span class="st">"sqrt_one_minus_alphas_cumprod"</span>].cpu().numpy())</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> plt.title(<span class="vs">r"$\sqrt{1-\bar\alpha_t}$: noise level"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2_1_diffusion_afhq_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="visualizing-forward-diffusion-on-an-image" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-forward-diffusion-on-an-image">Visualizing forward diffusion on an image</h3>
<div id="6bbcc71f" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:18.199170Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:18.198683Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:18.725562Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:18.725091Z&quot;}" data-outputid="10c287ea-0fbb-450c-a9ac-cdb16bdfc9ac" data-papermill="{&quot;duration&quot;:0.548791,&quot;end_time&quot;:&quot;2025-02-18T03:35:18.727116&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:18.178325&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's see what forward diffusion does.</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>x_0, _ <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(val_dataloader))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>x_0 <span class="op">=</span> x_0.to(device)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>x_t_list <span class="op">=</span> []</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>common_noise <span class="op">=</span> torch.randn_like(x_0)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f"x_0 std:", x_0[0].std().item())</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>noise_levels <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">500</span>]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> noise_levels:</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  t <span class="op">=</span> torch.full((x_0.shape[<span class="dv">0</span>],), t, device<span class="op">=</span>device)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  x_t_list.append(forward_diffusion(x_0, t, noise_schedule, noise<span class="op">=</span>common_noise)[<span class="dv">0</span>])</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">5</span>))</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (t, x_t) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(noise_levels, x_t_list)):</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(x_t[0].min().item(), x_t[0].max().item())</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  plt.subplot(<span class="dv">1</span>, <span class="dv">10</span>, i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  plt.title(<span class="ss">f"t=</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">, std=</span><span class="sc">{</span>x_t[<span class="dv">0</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  img <span class="op">=</span> x_t[<span class="dv">0</span>].cpu().numpy().transpose(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  img <span class="op">=</span> (img <span class="op">-</span> img.<span class="bu">min</span>()) <span class="op">/</span> (img.<span class="bu">max</span>() <span class="op">-</span> img.<span class="bu">min</span>())</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  plt.imshow(img)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i <span class="op">&gt;=</span> <span class="dv">10</span>:</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2_1_diffusion_afhq_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Through forward diffusion, the image quality actually appears to degrade quickly. By the time <span class="math inline">\(t=100\)</span>, the cat is almost not recognizable. By <span class="math inline">\(t=500\)</span>, the image is almost completely noise to the eye. Much of the diffusion process is spent on the “noise-dominant” regime, where the structured image is lost and what remains is a Gaussian-like noisy pattern.</p>
<p>This is helpful for the model to learn to denoise the image.</p>
<ul>
<li><p>By including a long regime where the image is essentially noise, the model learns how to reconstruct a clean image from a broad range of noise levels. This comprehensive exposure helps the model become more robust and generalize better.</p></li>
<li><p>The final goal at sampling time is to start from pure noise (around <span class="math inline">\(x_T\)</span>) and iteratively denoise until reaching a plausible sample <span class="math inline">\(x_0\)</span>. If the model had fewer steps and tried to denoise a still somewhat structured image in fewer transitions, it might be harder to learn a smooth, stable backward trajectory. The long noise regime ensures the model is comfortable dealing with extremely noisy inputs and making small, incremental corrections. ​</p></li>
</ul>
</section>
</section>
<section id="training-loop" class="level2">
<h2 class="anchored" data-anchor-id="training-loop">Training loop</h2>
<p>The core training step can be implemented in under 10 lines of code.</p>
<p>We teach the model to predict the “common noise” <span class="math inline">\(\mathbf\epsilon\)</span> that produced the diffusion sequence, based on <span class="math inline">\(x_t\)</span> at any time <span class="math inline">\(t\)</span>. No matter where it is, the model needs to help the image get back to <span class="math inline">\(x_0\)</span>.</p>
<div id="ce69ed30" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:18.860170Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:18.859626Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:56.739595Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:56.739098Z&quot;}" data-outputid="5f8bbcb7-54a6-4bbf-ec87-362d0947b12c" data-papermill="{&quot;duration&quot;:37.903715,&quot;end_time&quot;:&quot;2025-02-18T03:35:56.740516&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:18.836801&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> MSELoss()</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>denoising_model.train()</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(denoising_model, steps<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"Training on device:"</span>, device)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  max_train_steps <span class="op">=</span> steps</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  train_progress_bar <span class="op">=</span> tqdm(<span class="bu">enumerate</span>(itertools.cycle(train_dataloader)))</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  num_examples <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> step, (x_0, _) <span class="kw">in</span> train_progress_bar:</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    x_0 <span class="op">=</span> x_0.to(device)  <span class="co"># x_0 is the clean data to teach the model to generate</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    optimizer.zero_grad()</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#######################################</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start of Core training step</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#######################################</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    noise <span class="op">=</span> torch.randn(x_0.shape).to(device)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> torch.randint(<span class="dv">0</span>, config.num_denoising_steps, (x_0.shape[<span class="dv">0</span>],), device<span class="op">=</span>device).<span class="bu">long</span>()</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    x_t, true_noise <span class="op">=</span> forward_diffusion(x_0, t, noise_schedule, noise<span class="op">=</span>noise)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    predicted_noise <span class="op">=</span> denoising_model(t<span class="op">=</span>t, x<span class="op">=</span>x_t)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> criterion(predicted_noise, true_noise)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    loss.backward()<span class="op">;</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># torch.nn.utils.clip_grad_norm_(denoising_model.parameters(), 1)  # try commenting it out</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    optimizer.step()</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#######################################</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># End of Core training step</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#######################################</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    train_progress_bar.set_postfix({<span class="st">"loss"</span>: loss.cpu().item()})</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    num_examples <span class="op">+=</span> <span class="bu">len</span>(x_0)</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> step <span class="op">&gt;=</span> max_train_steps:</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="ss">f"Reached the max training steps:"</span>, max_train_steps)</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"Trained on </span><span class="sc">{</span>num_examples<span class="sc">}</span><span class="ss"> examples."</span>)</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> loss</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> train(denoising_model, steps<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training on device: cuda</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"687418d644d94e7eb3de06cc19369c88","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Reached the max training steps: 100
Trained on 3232 examples.
CPU times: user 27.7 s, sys: 10 s, total: 37.7 s
Wall time: 37.9 s</code></pre>
</div>
</div>
</section>
<section id="generate" class="level2">
<h2 class="anchored" data-anchor-id="generate">Generate</h2>
<section id="the-sampling-algorithm-reversing-the-diffusion-process" class="level3">
<h3 class="anchored" data-anchor-id="the-sampling-algorithm-reversing-the-diffusion-process">The sampling algorithm: reversing the diffusion process</h3>
<p>The sampling algorithm is the reverse of the forward diffusion process. It starts from <span class="math inline">\(x_T\)</span>, a pure noise image, and iteratively denoise until reaching <span class="math inline">\(x_0\)</span>.</p>
<p>The formula for one “denoising” step is:</p>
<p><span class="math display">\[
x_{t-1} = \frac{1}{\sqrt{\alpha_t}} (x_t - \frac{1-\alpha_t}{\sqrt{1 - \bar\alpha_t}} \mathbf\epsilon_{\theta}(\mathbf{x_t}, t)) + \sqrt{\tilde\beta_t} \mathbf z_t \tag{1}
\]</span></p>
<p>where <span class="math inline">\(z_t ~ \mathcal{N}(0, 1)\)</span> is Gaussian noise (independent from <span class="math inline">\(\mathbf\epsilon\)</span>) that is sampled at each denoising step, and <span class="math inline">\(\tilde\beta_t = \frac{1 - \bar\alpha_{t-1}}{1 - \bar\alpha_t} \beta_t\)</span> is the variance of the noise at time <span class="math inline">\(t\)</span>.</p>
<section id="the-clamping" class="level4">
<h4 class="anchored" data-anchor-id="the-clamping">The clamping</h4>
<p>If you compare the <code>denoising_step</code> function below with the implementation in the 2D point cloud tutorial, you will find that the one here to be more complex. It implements the following formula:</p>
<p><span class="math display">\[
\hat x_{0} = \frac{1}{\sqrt{\bar\alpha_t}} \left(x_t - \sqrt{1-\bar\alpha_t} \cdot \mathbf\epsilon_{\theta}(\mathbf{x_t}, t)\right) \tag{2}
\]</span></p>
<p>then</p>
<p><span class="math display">\[
x_{t-1} =  \frac{\beta_t\sqrt{\bar\alpha_{t-1}}}{1-\bar\alpha_t} \cdot \textrm{Clamp}(\hat x_{0}) + \frac{\sqrt{\alpha_t}(1-\bar\alpha_{t-1})}{1-\bar\alpha_t} x_t  + \sqrt{\beta_t} \mathbf z_t \tag{3}
\]</span></p>
<p>where <span class="math inline">\(\textrm{Clamp}(\hat x_{0})\)</span> is the clamping function that limits the range of the predicted image to be within <span class="math inline">\([-1, 1]\)</span>.</p>
<p>If there is no clamping, equation (1) is mathematically equivalent to equations (2) and (3) combined (derivations <a href="https://lilianweng.github.io/posts/2021-07-11-diffusion-models/">here</a>). However, clamping is found to be helpful in generating high quality images, especially during the early iterations of the training.</p>
<p>In summary, instead of directly predicting the previous sample,</p>
<p><span class="math display">\[
x_{t} \rightarrow x_{t-1}
\]</span></p>
<p>we predict the clean sample</p>
<p><span class="math display">\[
x_{t} \rightarrow x_{0}
\]</span></p>
<p>and then apply forward diffusion on the clean sample to get <span class="math inline">\(x_{t-1}\)</span>, with an optional clamping:</p>
<p><span class="math display">\[
x_{0} \rightarrow \textrm{Clamp}(x_{0}) \rightarrow x_{t-1}
\]</span>.</p>
<p>To see its effect, the more direct implementation <code>denoising_step_direct()</code> is also included for comparison. We will see why the new implementation with clamping is necessary.</p>
<div id="1552ec4c" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:56.870425Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:56.869979Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:35:56.904703Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:35:56.904309Z&quot;}" data-papermill="{&quot;duration&quot;:0.057856,&quot;end_time&quot;:&quot;2025-02-18T03:35:56.905569&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:56.847713&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> denoising_step(denoising_model, x_t, t, noise_schedule, thresholding<span class="op">=</span><span class="va">False</span>, clip_sample<span class="op">=</span><span class="va">True</span>, clip_sample_range<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">    This is the backward diffusion step, with the effect of denoising.</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(t, <span class="bu">int</span>):</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        t_tensor <span class="op">=</span> torch.full((x_t.shape[<span class="dv">0</span>],), t, device<span class="op">=</span>x_t.device)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        t_tensor <span class="op">=</span> t</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        model_output <span class="op">=</span> denoising_model(t<span class="op">=</span>t_tensor, x<span class="op">=</span>x_t)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(model_output, <span class="st">"sample"</span>):</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        model_output <span class="op">=</span> model_output.sample</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract relevant values from noise_schedule</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    alpha_prod_t <span class="op">=</span> noise_schedule[<span class="st">"alphas_cumprod"</span>][t_tensor]</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># deal with t=0 case where t can be a tensor</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    alpha_prod_t_prev <span class="op">=</span> torch.where(t_tensor <span class="op">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>                                    noise_schedule[<span class="st">"alphas_cumprod"</span>][t_tensor <span class="op">-</span> <span class="dv">1</span>],</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>                                    torch.ones_like(t_tensor, device<span class="op">=</span>x_t.device))</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reshape alpha_prod_t_prev for proper broadcasting</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    alpha_prod_t <span class="op">=</span> alpha_prod_t.view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    alpha_prod_t_prev <span class="op">=</span> alpha_prod_t_prev.view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    beta_prod_t <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> alpha_prod_t</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    beta_prod_t_prev <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> alpha_prod_t_prev</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    current_alpha_t <span class="op">=</span> alpha_prod_t <span class="op">/</span> alpha_prod_t_prev</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    current_beta_t <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> current_alpha_t</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the previous sample mean</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    pred_original_sample <span class="op">=</span> (x_t <span class="op">-</span> beta_prod_t <span class="op">**</span> <span class="fl">0.5</span> <span class="op">*</span> model_output) <span class="op">/</span> alpha_prod_t <span class="op">**</span> <span class="fl">0.5</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> clip_sample:</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>        pred_original_sample <span class="op">=</span> torch.clamp(pred_original_sample, <span class="op">-</span>clip_sample_range, clip_sample_range)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the coefficients for pred_original_sample and current sample</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    pred_original_sample_coeff <span class="op">=</span> (alpha_prod_t_prev <span class="op">**</span> <span class="fl">0.5</span> <span class="op">*</span> current_beta_t) <span class="op">/</span> beta_prod_t</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    current_sample_coeff <span class="op">=</span> current_alpha_t <span class="op">**</span> <span class="fl">0.5</span> <span class="op">*</span> beta_prod_t_prev <span class="op">/</span> beta_prod_t</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the previous sample</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    pred_prev_sample <span class="op">=</span> pred_original_sample_coeff <span class="op">*</span> pred_original_sample <span class="op">+</span> current_sample_coeff <span class="op">*</span> x_t</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add noise</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    variance <span class="op">=</span> torch.zeros_like(x_t)</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    variance_noise <span class="op">=</span> torch.randn_like(x_t)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle t=0 case where t can be a tensor</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    non_zero_mask <span class="op">=</span> (t_tensor <span class="op">!=</span> <span class="dv">0</span>).<span class="bu">float</span>().view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    variance <span class="op">=</span> non_zero_mask <span class="op">*</span> ((<span class="dv">1</span> <span class="op">-</span> alpha_prod_t_prev) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> alpha_prod_t) <span class="op">*</span> current_beta_t)</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    variance <span class="op">=</span> torch.clamp(variance, <span class="bu">min</span><span class="op">=</span><span class="fl">1e-20</span>)</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    pred_prev_sample <span class="op">=</span> pred_prev_sample <span class="op">+</span> (variance <span class="op">**</span> <span class="fl">0.5</span>) <span class="op">*</span> variance_noise</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pred_prev_sample</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> denoising_step_direct(</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    denoising_model,</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    x_t,</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    t,</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    noise_schedule,</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    clip_sample<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>    clip_sample_range<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a><span class="co">    This is the backward diffusion step, with the effect of denoising.</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(t, <span class="bu">int</span>):</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>        t_tensor <span class="op">=</span> torch.full((x_t.shape[<span class="dv">0</span>],), t, device<span class="op">=</span>x_t.device)</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>        t_tensor <span class="op">=</span> t</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>        eps_theta <span class="op">=</span> denoising_model(t<span class="op">=</span>t_tensor, x<span class="op">=</span>x_t)</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(eps_theta, <span class="st">"sample"</span>):</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>        eps_theta <span class="op">=</span> eps_theta.sample</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract alphas from noise schedule</span></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>    alpha_t <span class="op">=</span> noise_schedule[<span class="st">"alphas"</span>][t_tensor]</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>    alpha_t_cumprod <span class="op">=</span> noise_schedule[<span class="st">"alphas_cumprod"</span>][t_tensor]</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reshape for broadcasting</span></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>    view_shape <span class="op">=</span> (<span class="op">-</span><span class="dv">1</span>,) <span class="op">+</span> (<span class="dv">1</span>,) <span class="op">*</span> (x_t.ndim <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>    alpha_t <span class="op">=</span> alpha_t.view(<span class="op">*</span>view_shape)</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>    alpha_t_cumprod <span class="op">=</span> alpha_t_cumprod.view(<span class="op">*</span>view_shape)</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate epsilon factor</span></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>    eps_factor <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> alpha_t) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> alpha_t_cumprod).sqrt()</span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate mean for reverse process</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>    mean <span class="op">=</span> (<span class="dv">1</span> <span class="op">/</span> torch.sqrt(alpha_t)) <span class="op">*</span> (x_t <span class="op">-</span> eps_factor <span class="op">*</span> eps_theta)</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add noise scaled by variance for non-zero timesteps</span></span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>    noise <span class="op">=</span> torch.randn_like(x_t)</span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>    beta_t <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> alpha_t</span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>    variance <span class="op">=</span> beta_t <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> alpha_t_cumprod <span class="op">/</span> alpha_t) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> alpha_t_cumprod)</span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>    variance <span class="op">=</span> torch.clamp(variance, <span class="bu">min</span><span class="op">=</span><span class="fl">1e-20</span>)  <span class="co"># Add clamp to prevent numerical instability</span></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mask out noise for t=0 timesteps</span></span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a>    non_zero_mask <span class="op">=</span> (t_tensor <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">float</span>().view(<span class="op">*</span>view_shape)</span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a>    noise_scale <span class="op">=</span> torch.sqrt(variance) <span class="op">*</span> non_zero_mask</span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a>    pred_prev_sample <span class="op">=</span> mean <span class="op">+</span> noise_scale <span class="op">*</span> noise</span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply clipping</span></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> clip_sample:</span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a>        pred_prev_sample <span class="op">=</span> torch.clamp(pred_prev_sample, <span class="op">-</span>clip_sample_range, clip_sample_range)</span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pred_prev_sample</span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_samples_by_denoising(denoising_model, x_T, noise_schedule, n_T, device, thresholding<span class="op">=</span><span class="va">False</span>, clip_sample<span class="op">=</span><span class="va">True</span>, clip_sample_range<span class="op">=</span><span class="fl">1.0</span>, seed<span class="op">=</span><span class="dv">0</span>, method<span class="op">=</span><span class="st">"direct"</span>):</span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a><span class="co">    This is the generation process.</span></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a>    torch.manual_seed(seed)</span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a>    x_t <span class="op">=</span> x_T.to(device)</span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a>    pbar <span class="op">=</span> tqdm(<span class="bu">range</span>(n_T <span class="op">-</span> <span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> pbar:</span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> method <span class="op">==</span> <span class="st">"direct"</span>:</span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a>            x_t <span class="op">=</span> denoising_step_direct(denoising_model, x_t, t, noise_schedule, clip_sample, clip_sample_range)</span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a>            x_t <span class="op">=</span> denoising_step(denoising_model, x_t, t, noise_schedule, thresholding, clip_sample, clip_sample_range)</span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a>        pbar.set_postfix({<span class="st">"std"</span>: x_t.std().item()})</span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print("raw x_t range", x_t.min(), x_t.max())</span></span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a>    x_t <span class="op">=</span> (x_t <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> <span class="fl">0.5</span>).clamp(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print("after clamp", x_t.min(), x_t.max())</span></span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="visualize-sampled-images" class="level3">
<h3 class="anchored" data-anchor-id="visualize-sampled-images">Visualize sampled images</h3>
<section id="without-clamping" class="level4">
<h4 class="anchored" data-anchor-id="without-clamping">Without clamping</h4>
<p>First we visualize the sampled images without clamping.</p>
<div id="645400c8" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:35:56.991776Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:35:56.991428Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:36:53.530712Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:36:53.530312Z&quot;}" data-outputid="f8ea9e82-8f96-4cbf-8111-d3523a03523c" data-papermill="{&quot;duration&quot;:56.562075,&quot;end_time&quot;:&quot;2025-02-18T03:36:53.531601&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:35:56.969526&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the sampled images</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_sampled_images(method<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"Loss of the denoising model:"</span>, loss.item())</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  x_T <span class="op">=</span> torch.randn(<span class="dv">16</span>, <span class="dv">3</span>, config.resolution, config.resolution)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  x_sampled <span class="op">=</span> generate_samples_by_denoising(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    denoising_model, x_T,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    noise_schedule, n_T<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    device<span class="op">=</span>device,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    clip_sample<span class="op">=</span><span class="va">False</span> <span class="cf">if</span> method <span class="op">==</span> <span class="st">"direct"</span> <span class="cf">else</span> <span class="va">True</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    clip_sample_range<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span>method,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  x_sampled <span class="op">=</span> x_sampled <span class="op">*</span> <span class="dv">255</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  sampled <span class="op">=</span> make_grid(x_sampled).permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>).cpu().numpy().astype(np.uint8)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  _ <span class="op">=</span> plt.imshow(sampled)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>visualize_sampled_images(method<span class="op">=</span><span class="st">"direct"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loss of the denoising model: 0.049650758504867554</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0c69bc3a7abc4c28840f755ca6aac3d8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2_1_diffusion_afhq_files/figure-html/cell-16-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="with-clamping" class="level4">
<h4 class="anchored" data-anchor-id="with-clamping">With clamping</h4>
<p>Now we visualize the sampled images with clamping.</p>
<div id="da07ee4f" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:36:53.626866Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:36:53.626530Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:37:50.739868Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:37:50.739485Z&quot;}" data-papermill="{&quot;duration&quot;:57.137881,&quot;end_time&quot;:&quot;2025-02-18T03:37:50.740672&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:36:53.602791&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>visualize_sampled_images()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loss of the denoising model: 0.049650758504867554</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9509eb21321d45288f596df2746ad0b2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 57 s, sys: 116 ms, total: 57.1 s
Wall time: 57 s</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2_1_diffusion_afhq_files/figure-html/cell-17-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="train-some-more" class="level3">
<h3 class="anchored" data-anchor-id="train-some-more">Train some more</h3>
<div id="92b461c4" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:37:50.843345Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:37:50.843007Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:44:22.391847Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:44:22.391423Z&quot;}" data-outputid="f75a00c2-d5b8-40b8-cb76-f9ee9b153ff5" data-papermill="{&quot;duration&quot;:391.575527,&quot;end_time&quot;:&quot;2025-02-18T03:44:22.392685&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:37:50.817158&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="17">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Train some more</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> train(denoising_model, steps<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"loss:"</span>, loss.item())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training on device: cuda</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0fa287cf3a71496a86504da22751aef1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Reached the max training steps: 1000
Trained on 31998 examples.
loss: 0.016148239374160767
CPU times: user 4min 37s, sys: 1min 43s, total: 6min 20s
Wall time: 6min 31s</code></pre>
</div>
</div>
<p>Again, let’s compare the sampled images with and without clamping.</p>
<section id="generate-with-clamping" class="level4">
<h4 class="anchored" data-anchor-id="generate-with-clamping">Generate with clamping</h4>
<div id="e179954b" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:44:22.496567Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:44:22.496062Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:45:22.887679Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:45:22.887035Z&quot;}" data-outputid="3fddfdf4-d80e-47f2-f4f9-2b8a515abe0f" data-papermill="{&quot;duration&quot;:60.419252,&quot;end_time&quot;:&quot;2025-02-18T03:45:22.888544&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:44:22.469292&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="18">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>visualize_sampled_images()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loss of the denoising model: 0.016148239374160767</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"08aec6006bab4118be9a7a1d9bc8efc8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2_1_diffusion_afhq_files/figure-html/cell-19-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="generate-without-clamping" class="level4">
<h4 class="anchored" data-anchor-id="generate-without-clamping">Generate without clamping</h4>
<div id="8296693a" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:45:23.002648Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:45:23.002279Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T03:46:22.591919Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T03:46:22.591545Z&quot;}" data-papermill="{&quot;duration&quot;:59.618245,&quot;end_time&quot;:&quot;2025-02-18T03:46:22.592751&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:45:22.974506&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="19">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>visualize_sampled_images(method<span class="op">=</span><span class="st">"direct"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loss of the denoising model: 0.016148239374160767</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e5231bc08d484aed8f3324215596591d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2_1_diffusion_afhq_files/figure-html/cell-20-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="train-even-more" class="level3">
<h3 class="anchored" data-anchor-id="train-even-more">Train even more</h3>
<section id="generate-with-clamping-1" class="level4">
<h4 class="anchored" data-anchor-id="generate-with-clamping-1">Generate with clamping</h4>
<div id="be4bbad9" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T03:46:22.711484Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T03:46:22.711106Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T04:19:28.327150Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T04:19:28.326745Z&quot;}" data-outputid="4afee568-bdf9-430b-876e-1f2816e6e175" data-papermill="{&quot;duration&quot;:1985.646996,&quot;end_time&quot;:&quot;2025-02-18T04:19:28.328079&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T03:46:22.681083&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="20">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> g <span class="kw">in</span> optimizer.param_groups:</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    g[<span class="st">'lr'</span>] <span class="op">=</span> <span class="fl">1e-4</span>  <span class="co"># reduce learning rate</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> train(denoising_model, steps<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"loss:"</span>, loss.item())</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>visualize_sampled_images()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training on device: cuda</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"91ea646d4b5d4c22887eb12afff7fb7a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Reached the max training steps: 5000
Trained on 159828 examples.
loss: 0.017624855041503906
Loss of the denoising model: 0.017624855041503906</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a1ce810f567442d3b1d5b9faa455a81d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 24min 14s, sys: 8min 50s, total: 33min 5s
Wall time: 33min 5s</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2_1_diffusion_afhq_files/figure-html/cell-21-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="generate-without-clamping-1" class="level4">
<h4 class="anchored" data-anchor-id="generate-without-clamping-1">Generate without clamping</h4>
<div id="06f30c7c" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T04:19:28.454044Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T04:19:28.453589Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T04:20:26.226111Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T04:20:26.225719Z&quot;}" data-papermill="{&quot;duration&quot;:57.804033,&quot;end_time&quot;:&quot;2025-02-18T04:20:26.226984&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T04:19:28.422951&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="21">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>visualize_sampled_images(method<span class="op">=</span><span class="st">"direct"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loss of the denoising model: 0.017624855041503906</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"03d5685bd1a940e185d16a0f29e124dc","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2_1_diffusion_afhq_files/figure-html/cell-22-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="and-some-more" class="level3">
<h3 class="anchored" data-anchor-id="and-some-more">And, some more</h3>
<div id="860a89f5" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T04:20:26.357090Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T04:20:26.356740Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T05:36:41.387443Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T05:36:41.387001Z&quot;}" data-outputid="d56c68d0-5586-4248-925f-0ae73056a1c6" data-papermill="{&quot;duration&quot;:4575.063749,&quot;end_time&quot;:&quot;2025-02-18T05:36:41.388260&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T04:20:26.324511&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="22">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> g <span class="kw">in</span> optimizer.param_groups:</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    g[<span class="st">'lr'</span>] <span class="op">=</span> <span class="fl">1e-4</span>  <span class="co"># reduce learning rate</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> train(denoising_model, steps<span class="op">=</span><span class="dv">12000</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"loss:"</span>, loss.item())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training on device: cuda</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7810cf10727b4020b15503490d872550","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Reached the max training steps: 12000
Trained on 383539 examples.
loss: 0.049816668033599854
CPU times: user 55min 12s, sys: 21min 2s, total: 1h 16min 15s
Wall time: 1h 16min 15s</code></pre>
</div>
</div>
<section id="generate-without-clamping-2" class="level4">
<h4 class="anchored" data-anchor-id="generate-without-clamping-2">Generate without clamping</h4>
<div id="7acbb3ee" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T05:36:41.454252Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T05:36:41.453785Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T05:37:39.274784Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T05:37:39.274379Z&quot;}" data-papermill="{&quot;duration&quot;:57.854553,&quot;end_time&quot;:&quot;2025-02-18T05:37:39.275643&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T05:36:41.421090&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="23">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>visualize_sampled_images(method<span class="op">=</span><span class="st">"direct"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loss of the denoising model: 0.049816668033599854</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0037c48eafae43dd9fec6f55872cd933","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2_1_diffusion_afhq_files/figure-html/cell-24-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="generate-with-clamping-2" class="level4">
<h4 class="anchored" data-anchor-id="generate-with-clamping-2">Generate with clamping</h4>
<div id="6f6c4d30" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2025-02-18T05:37:39.346794Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-02-18T05:37:39.346618Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-02-18T05:38:37.186877Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-02-18T05:38:37.186465Z&quot;}" data-papermill="{&quot;duration&quot;:57.875536,&quot;end_time&quot;:&quot;2025-02-18T05:38:37.187680&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2025-02-18T05:37:39.312144&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="24">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>visualize_sampled_images()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loss of the denoising model: 0.049816668033599854</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ba4a7a4e9fd64ea9aea2e38798e360b6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2_1_diffusion_afhq_files/figure-html/cell-25-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can see that the images generating without clamping now almost caught up in quality, as the model becomes more robust.</p>
<p>With almost 20k steps of training, the model seems to grasp the main features of animal faces. It is a successful proof of concept. However, there are still frequent distortion and artifacts which give a clear “bot smell”.</p>
<p>The model will continue to learn from here but will progress more slowly. Here is an <a href="https://wandb.ai/zzsi_kungfu/nano-diffusion/runs/6a46kmna/workspace?nw=nwuserzzsi_kungfu">8 hour training run</a> on a Lambda Labs A10 instance.</p>
<p>To faciliate open source research and reproducibility, we release the complete training logs in this course on Weights and Biases.</p>
</section>
</section>
<section id="quantitative-evaluation-of-image-quality" class="level3">
<h3 class="anchored" data-anchor-id="quantitative-evaluation-of-image-quality">Quantitative Evaluation of Image Quality</h3>
<p>In the <a href="./2_2_fid.html">image quality evaluation</a> tutorial, we will go over several metrics to measure the quality of generated images. A common metric is the “FID” score, which measures the Frechet Inception Distance between the image embeddings of generated images and the real images.</p>
</section>
</section>
<section id="questions-for-futher-exploration" class="level1">
<h1>Questions for Futher Exploration</h1>
<ul>
<li>How does the model size affect quality of samples (number of parameters, controlled by the number of layers, and number of hidden units)?</li>
<li>How does learing rate affect model quality?</li>
<li>The current image resolution is 64x64. If we increase it to 128 or 256, how does it affect training speed and sample quality? Do you anticipate challenges when we scale to 512x512 or higher resolutions?</li>
</ul>


</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{"0037c48eafae43dd9fec6f55872cd933":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_3483b891ff204144a82f79a8c19c3c6d","IPY_MODEL_15e2d51b3ba844f5ab8cc0568f562768","IPY_MODEL_83c78219131a4bbe8df3a09d5688f073"],"layout":"IPY_MODEL_b8ea4b5060b547eeb42b92eb280e4207","tabbable":null,"tooltip":null}},"03d5685bd1a940e185d16a0f29e124dc":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_7175ada12e3a4586a84ffb47c559c91b","IPY_MODEL_68cc58137b3943098818a1bd16e4bb13","IPY_MODEL_499bf082f825489abd031dfde4f1e31d"],"layout":"IPY_MODEL_a202f15e1411454eb397ed76154b93c4","tabbable":null,"tooltip":null}},"03ed03645fd340a8a5165dbddbc6fcdf":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"danger","description":"","description_allow_html":false,"layout":"IPY_MODEL_b1a7f1f2945c4adfab4322c419ce20b5","max":1,"min":0,"orientation":"horizontal","style":"IPY_MODEL_4054f9ff13a64c2a830279703f2e198c","tabbable":null,"tooltip":null,"value":1}},"05569f1d0cdf4f0b9a621ecc18047cf2":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"059e572005954eef811d5908cb7b26c2":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_f86747ad7ddc48879815e675c6582206","placeholder":"​","style":"IPY_MODEL_2cbd6f977c1b48cab2f99492735cbf7f","tabbable":null,"tooltip":null,"value":" 1000/1000 [00:56&lt;00:00, 17.49it/s, std=0.366]"}},"05fdf75627da467dab386fffb70f3b89":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"07e70155cf1b45f98b07fdc054c2fd7e":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_dd64977ca35847d2be1542abd31ca9bb","placeholder":"​","style":"IPY_MODEL_8c065092c21844fc849d5351aba5715d","tabbable":null,"tooltip":null,"value":""}},"08aec6006bab4118be9a7a1d9bc8efc8":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_c7f805dc1f124c6195b6316d70ee2586","IPY_MODEL_4016c3f8bd7a4638830f7ae9f8e7992c","IPY_MODEL_22f86f0bfdb949e89242a376db8d2811"],"layout":"IPY_MODEL_3c4935566ae94e639207e7320af41aaa","tabbable":null,"tooltip":null}},"08d7b25afbfc4bff9668145ba683d066":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"09853c109c8c4f7a9ab305a6eb5fd2ef":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"0be60d7712264dceaae1de9db8a46769":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"0c69bc3a7abc4c28840f755ca6aac3d8":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_e9b3119946e244a3a176907d643bca0d","IPY_MODEL_5c1f153b29154f9392f0cbfff5bd08e9","IPY_MODEL_983bb23e6e344d18a1edcd9eae60023b"],"layout":"IPY_MODEL_58b64e76e25c453cb9751a9b9fa37aea","tabbable":null,"tooltip":null}},"0f81f5a9d19e49fcaf18a172b31cc804":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"0fa287cf3a71496a86504da22751aef1":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_8bc7e660883f4c4f826d6ccb532b792b","IPY_MODEL_61c5330d8db949a5b0c58bca1eaa3383","IPY_MODEL_dce0579c184c4e389aa8e16660788a39"],"layout":"IPY_MODEL_0f81f5a9d19e49fcaf18a172b31cc804","tabbable":null,"tooltip":null}},"0fd3a004c66e451eb1ba434dabaccec0":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"114f54d05b7a4e79829d8feac5965081":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"11764b103ccb49efada8c180ae430b87":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"danger","description":"","description_allow_html":false,"layout":"IPY_MODEL_59bbe4622488448e909e30d1d460fc6c","max":1,"min":0,"orientation":"horizontal","style":"IPY_MODEL_de0245e170204766921adfd3665f0785","tabbable":null,"tooltip":null,"value":1}},"131a3e577d1540d0970dd6e290f43035":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"157be36c8cad4f0e8ac809cc07cd2b42":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"15e2d51b3ba844f5ab8cc0568f562768":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_cee30dd614e8454194486d2774a36e4a","max":1000,"min":0,"orientation":"horizontal","style":"IPY_MODEL_0fd3a004c66e451eb1ba434dabaccec0","tabbable":null,"tooltip":null,"value":1000}},"173cf7896ea645498ace4e55c30f435f":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"17f30090fa614c83b24725a7432984dd":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"1d06386b627c4c9dbd42cb321792d482":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"2040390520fc4a1f8adfde4c39999c09":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"22f86f0bfdb949e89242a376db8d2811":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_a697cf5333104ceaabafc71a570fce9c","placeholder":"​","style":"IPY_MODEL_963315968a524236a0df3cc9be11958c","tabbable":null,"tooltip":null,"value":" 1000/1000 [01:00&lt;00:00, 17.32it/s, std=0.451]"}},"23bcee4933d042d58c01fdf61f734d8f":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"danger","description":"","description_allow_html":false,"layout":"IPY_MODEL_2e66fac912204e5c927c6e9c972d90e0","max":1,"min":0,"orientation":"horizontal","style":"IPY_MODEL_f753f2772a73442abe73b168ba9bb609","tabbable":null,"tooltip":null,"value":1}},"24d2555eaf9d47c3a79cc26a0ddafca7":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"2ba7eb132b124973973287163d1c808b":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"2cbd6f977c1b48cab2f99492735cbf7f":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"2e65dac7ef4b427d829c12f36d8b9a2f":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"2e66fac912204e5c927c6e9c972d90e0":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":"20px"}},"30869204130542f287fd59e5115fcbe7":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_2e65dac7ef4b427d829c12f36d8b9a2f","max":1000,"min":0,"orientation":"horizontal","style":"IPY_MODEL_8d29c62945244dd9b401516dfd34ac1b","tabbable":null,"tooltip":null,"value":1000}},"30903960bf264cb4893554820ce8832f":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"3483b891ff204144a82f79a8c19c3c6d":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_d3b64545a0b94a7aace00909ce1a22dd","placeholder":"​","style":"IPY_MODEL_eee6c83b52df4eb8af217d14d80c765a","tabbable":null,"tooltip":null,"value":"100%"}},"36d5c342cd7d4987bed56031638e79c1":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"38b272976a9c4bd8ab2e16b01905cff1":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"3c4935566ae94e639207e7320af41aaa":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"3c76b440a710445f921649d71bbc95c6":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"3cb033482cee46aa8fa07d6845c70731":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"40161f2b49fa443eb4535102aa58ddc9":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"4016c3f8bd7a4638830f7ae9f8e7992c":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_425de9ecf6894a878ecf109e4a6ff173","max":1000,"min":0,"orientation":"horizontal","style":"IPY_MODEL_17f30090fa614c83b24725a7432984dd","tabbable":null,"tooltip":null,"value":1000}},"4054f9ff13a64c2a830279703f2e198c":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"425de9ecf6894a878ecf109e4a6ff173":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"490052cfa53e47ed9752274cd6d2ae22":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"499bf082f825489abd031dfde4f1e31d":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_b6239319c28744c7afe3fcd82c2c2b06","placeholder":"​","style":"IPY_MODEL_9ddf6ff0adca410c981d07bd558df2c4","tabbable":null,"tooltip":null,"value":" 1000/1000 [00:57&lt;00:00, 17.31it/s, std=0.84]"}},"5072779d4da14b73bbaee308d5fb4a4f":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"513acc8551954855afedff4987890b51":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"520ff4b8da8d45108d5f876520e22d0f":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"52d11e4ee3aa4d1cbc161948c473f742":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"55d4d6fadad647cfbba7ebf2c3b063d3":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"5758e1248fbf47ccad82b0ace176c1b1":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"58b64e76e25c453cb9751a9b9fa37aea":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"59bbe4622488448e909e30d1d460fc6c":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":"20px"}},"5c1f153b29154f9392f0cbfff5bd08e9":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_685d856c3d984768b3d8c123fdf62326","max":1000,"min":0,"orientation":"horizontal","style":"IPY_MODEL_173cf7896ea645498ace4e55c30f435f","tabbable":null,"tooltip":null,"value":1000}},"5d1b139693c34b6bb49eee1453e9f9ab":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"5d578975586646a4b0d9a3fe3d250ab6":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_114f54d05b7a4e79829d8feac5965081","max":1000,"min":0,"orientation":"horizontal","style":"IPY_MODEL_05fdf75627da467dab386fffb70f3b89","tabbable":null,"tooltip":null,"value":1000}},"60ef1f85b2fd41ffb84da9426b1be1ad":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"61c5330d8db949a5b0c58bca1eaa3383":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"danger","description":"","description_allow_html":false,"layout":"IPY_MODEL_763b3017eee64d55939cd721c0a8fd53","max":1,"min":0,"orientation":"horizontal","style":"IPY_MODEL_5d1b139693c34b6bb49eee1453e9f9ab","tabbable":null,"tooltip":null,"value":1}},"64b29ecefeed42e9ae30ddefcf01a3b0":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"66b3cf9debe6452c8005f637661b44b9":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_1d06386b627c4c9dbd42cb321792d482","placeholder":"​","style":"IPY_MODEL_64b29ecefeed42e9ae30ddefcf01a3b0","tabbable":null,"tooltip":null,"value":" 1000/1000 [00:57&lt;00:00, 17.31it/s, std=0.522]"}},"685d856c3d984768b3d8c123fdf62326":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"687418d644d94e7eb3de06cc19369c88":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_74f4fb89726245e8976ecd3ace7f57c0","IPY_MODEL_11764b103ccb49efada8c180ae430b87","IPY_MODEL_91f77e84126c41d689a4f97670f0f4bb"],"layout":"IPY_MODEL_c419a6252dee4185b8342a49e57cdc0d","tabbable":null,"tooltip":null}},"68cc58137b3943098818a1bd16e4bb13":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_6f9e54bcddae45399601a692108f3684","max":1000,"min":0,"orientation":"horizontal","style":"IPY_MODEL_c0a33e0935784c25a4b1950144dd833a","tabbable":null,"tooltip":null,"value":1000}},"6aa6771b99284b1ab2d216205a2ee2b9":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"6ae6ef93615a4ace955e21ebfaad266b":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_55d4d6fadad647cfbba7ebf2c3b063d3","placeholder":"​","style":"IPY_MODEL_7778b632b9aa40e9b106b3d4a1c50884","tabbable":null,"tooltip":null,"value":" 1000/1000 [00:59&lt;00:00, 17.39it/s, std=1.49]"}},"6e524e86c3274986aaa5c75e98ca9743":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"6f9e54bcddae45399601a692108f3684":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"6ff2242fe3a843fa990943a91a3031a5":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"7175ada12e3a4586a84ffb47c559c91b":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_d4983d3cfcf9482eb280de0d93f71c56","placeholder":"​","style":"IPY_MODEL_60ef1f85b2fd41ffb84da9426b1be1ad","tabbable":null,"tooltip":null,"value":"100%"}},"74f4fb89726245e8976ecd3ace7f57c0":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_f902be161a7740f8921bc95b89b87d01","placeholder":"​","style":"IPY_MODEL_fc10079518364796aba41199ee3e6726","tabbable":null,"tooltip":null,"value":""}},"75fb232b589f420284c1414a847550f7":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_0be60d7712264dceaae1de9db8a46769","placeholder":"​","style":"IPY_MODEL_131a3e577d1540d0970dd6e290f43035","tabbable":null,"tooltip":null,"value":"100%"}},"763b3017eee64d55939cd721c0a8fd53":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":"20px"}},"7778b632b9aa40e9b106b3d4a1c50884":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"7810cf10727b4020b15503490d872550":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_ebd90c05d26a4520904e3b81dbaadd12","IPY_MODEL_03ed03645fd340a8a5165dbddbc6fcdf","IPY_MODEL_ee5c784a16c7469bbd66cef60d5a06bd"],"layout":"IPY_MODEL_2ba7eb132b124973973287163d1c808b","tabbable":null,"tooltip":null}},"7977857ec63c4047aebf2ecdf79cf1ed":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"7ad12aa155c44ec7a0a41ba87e54232c":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"7c0ce2deaf9e4928b0ac045db002e214":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_513acc8551954855afedff4987890b51","placeholder":"​","style":"IPY_MODEL_6e524e86c3274986aaa5c75e98ca9743","tabbable":null,"tooltip":null,"value":"100%"}},"7cb76758f9584ea5943cd821ec80e7f9":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"7ef234d6cada4fe8b33c16d65d06ddb7":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"8361337cfa954895b20f169723247e69":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"83c78219131a4bbe8df3a09d5688f073":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_8361337cfa954895b20f169723247e69","placeholder":"​","style":"IPY_MODEL_7977857ec63c4047aebf2ecdf79cf1ed","tabbable":null,"tooltip":null,"value":" 1000/1000 [00:57&lt;00:00, 17.34it/s, std=0.519]"}},"8bc7e660883f4c4f826d6ccb532b792b":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_40161f2b49fa443eb4535102aa58ddc9","placeholder":"​","style":"IPY_MODEL_8f0cc4899c264072a5648dd0b1914d78","tabbable":null,"tooltip":null,"value":""}},"8c065092c21844fc849d5351aba5715d":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"8d29c62945244dd9b401516dfd34ac1b":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"8f09540fa48b44fcac9771fcf681713d":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"8f0cc4899c264072a5648dd0b1914d78":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"91ea646d4b5d4c22887eb12afff7fb7a":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_07e70155cf1b45f98b07fdc054c2fd7e","IPY_MODEL_23bcee4933d042d58c01fdf61f734d8f","IPY_MODEL_e8fd17ebd6ec40ab93e6fb7ae053e8d2"],"layout":"IPY_MODEL_6ff2242fe3a843fa990943a91a3031a5","tabbable":null,"tooltip":null}},"91f77e84126c41d689a4f97670f0f4bb":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_08d7b25afbfc4bff9668145ba683d066","placeholder":"​","style":"IPY_MODEL_3cb033482cee46aa8fa07d6845c70731","tabbable":null,"tooltip":null,"value":" 100/? [00:37&lt;00:00,  2.68it/s, loss=0.0497]"}},"9509eb21321d45288f596df2746ad0b2":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_75fb232b589f420284c1414a847550f7","IPY_MODEL_5d578975586646a4b0d9a3fe3d250ab6","IPY_MODEL_059e572005954eef811d5908cb7b26c2"],"layout":"IPY_MODEL_2040390520fc4a1f8adfde4c39999c09","tabbable":null,"tooltip":null}},"963315968a524236a0df3cc9be11958c":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"9789e580b95343ca91df48f168a37033":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_52d11e4ee3aa4d1cbc161948c473f742","max":1000,"min":0,"orientation":"horizontal","style":"IPY_MODEL_5758e1248fbf47ccad82b0ace176c1b1","tabbable":null,"tooltip":null,"value":1000}},"983bb23e6e344d18a1edcd9eae60023b":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_f9232133206e449cb498e82faca674fd","placeholder":"​","style":"IPY_MODEL_36d5c342cd7d4987bed56031638e79c1","tabbable":null,"tooltip":null,"value":" 1000/1000 [00:56&lt;00:00, 17.63it/s, std=0.822]"}},"9bfa224c5a0445dea0ec7491bcea78f8":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_157be36c8cad4f0e8ac809cc07cd2b42","placeholder":"​","style":"IPY_MODEL_5072779d4da14b73bbaee308d5fb4a4f","tabbable":null,"tooltip":null,"value":"100%"}},"9ddf6ff0adca410c981d07bd558df2c4":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"a1ce810f567442d3b1d5b9faa455a81d":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_7c0ce2deaf9e4928b0ac045db002e214","IPY_MODEL_dfbded1539d04d06bf89a58acbdc340e","IPY_MODEL_66b3cf9debe6452c8005f637661b44b9"],"layout":"IPY_MODEL_e5b4ccb4131c4eb58025079cdf4d126b","tabbable":null,"tooltip":null}},"a202f15e1411454eb397ed76154b93c4":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"a697cf5333104ceaabafc71a570fce9c":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"a78a84c0c1eb460b8d143852a183e83a":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"b1a7f1f2945c4adfab4322c419ce20b5":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":"20px"}},"b6239319c28744c7afe3fcd82c2c2b06":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"b8ea4b5060b547eeb42b92eb280e4207":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"ba4a7a4e9fd64ea9aea2e38798e360b6":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_e631546996ff439f9d2ffaadc3c1c9e3","IPY_MODEL_30869204130542f287fd59e5115fcbe7","IPY_MODEL_f8bd59e98bba42ecaf9045bb94b87815"],"layout":"IPY_MODEL_7ad12aa155c44ec7a0a41ba87e54232c","tabbable":null,"tooltip":null}},"bc0edf51c9a94975978e1a6b5b229287":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"bd95795c9dc44726a1ae1190b28b7da4":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"c0a33e0935784c25a4b1950144dd833a":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"c419a6252dee4185b8342a49e57cdc0d":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"c7f805dc1f124c6195b6316d70ee2586":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_3c76b440a710445f921649d71bbc95c6","placeholder":"​","style":"IPY_MODEL_30903960bf264cb4893554820ce8832f","tabbable":null,"tooltip":null,"value":"100%"}},"c94149244bdd4de6a5746aa0eebe08f2":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"cee30dd614e8454194486d2774a36e4a":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"d384c3d7ddcb4d36ae06e7e2e4e55d8f":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"d3b64545a0b94a7aace00909ce1a22dd":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"d4983d3cfcf9482eb280de0d93f71c56":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"dce0579c184c4e389aa8e16660788a39":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_490052cfa53e47ed9752274cd6d2ae22","placeholder":"​","style":"IPY_MODEL_24d2555eaf9d47c3a79cc26a0ddafca7","tabbable":null,"tooltip":null,"value":" 1000/? [06:31&lt;00:00,  2.63it/s, loss=0.0161]"}},"dd64977ca35847d2be1542abd31ca9bb":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"de0245e170204766921adfd3665f0785":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"dfbded1539d04d06bf89a58acbdc340e":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_a78a84c0c1eb460b8d143852a183e83a","max":1000,"min":0,"orientation":"horizontal","style":"IPY_MODEL_6aa6771b99284b1ab2d216205a2ee2b9","tabbable":null,"tooltip":null,"value":1000}},"e5231bc08d484aed8f3324215596591d":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_9bfa224c5a0445dea0ec7491bcea78f8","IPY_MODEL_9789e580b95343ca91df48f168a37033","IPY_MODEL_6ae6ef93615a4ace955e21ebfaad266b"],"layout":"IPY_MODEL_d384c3d7ddcb4d36ae06e7e2e4e55d8f","tabbable":null,"tooltip":null}},"e5b4ccb4131c4eb58025079cdf4d126b":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"e631546996ff439f9d2ffaadc3c1c9e3":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_520ff4b8da8d45108d5f876520e22d0f","placeholder":"​","style":"IPY_MODEL_05569f1d0cdf4f0b9a621ecc18047cf2","tabbable":null,"tooltip":null,"value":"100%"}},"e8fd17ebd6ec40ab93e6fb7ae053e8d2":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_bc0edf51c9a94975978e1a6b5b229287","placeholder":"​","style":"IPY_MODEL_8f09540fa48b44fcac9771fcf681713d","tabbable":null,"tooltip":null,"value":" 5000/? [32:07&lt;00:00,  2.62it/s, loss=0.0176]"}},"e9b3119946e244a3a176907d643bca0d":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_09853c109c8c4f7a9ab305a6eb5fd2ef","placeholder":"​","style":"IPY_MODEL_7ef234d6cada4fe8b33c16d65d06ddb7","tabbable":null,"tooltip":null,"value":"100%"}},"eb9a685ea8f4413082781a03906faac2":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"ebd90c05d26a4520904e3b81dbaadd12":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_38b272976a9c4bd8ab2e16b01905cff1","placeholder":"​","style":"IPY_MODEL_7cb76758f9584ea5943cd821ec80e7f9","tabbable":null,"tooltip":null,"value":""}},"ee5c784a16c7469bbd66cef60d5a06bd":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_eb9a685ea8f4413082781a03906faac2","placeholder":"​","style":"IPY_MODEL_f5e7aa41e4764873a5601f97874a4044","tabbable":null,"tooltip":null,"value":" 12000/? [1:16:14&lt;00:00,  2.62it/s, loss=0.0498]"}},"eee6c83b52df4eb8af217d14d80c765a":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"f5e7aa41e4764873a5601f97874a4044":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"f753f2772a73442abe73b168ba9bb609":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"f86747ad7ddc48879815e675c6582206":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"f8bd59e98bba42ecaf9045bb94b87815":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_bd95795c9dc44726a1ae1190b28b7da4","placeholder":"​","style":"IPY_MODEL_c94149244bdd4de6a5746aa0eebe08f2","tabbable":null,"tooltip":null,"value":" 1000/1000 [00:57&lt;00:00, 17.35it/s, std=0.464]"}},"f902be161a7740f8921bc95b89b87d01":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"f9232133206e449cb498e82faca674fd":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"fc10079518364796aba41199ee3e6726":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}}},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/kungfuai\.github\.io\/nano-diffusion\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
  </div>
  <div class="nav-page nav-page-next">
      <a href="./2_1_a_move_off_notebook.html" class="pagination-link" aria-label="Time to move off of the notebook">
        <span class="nav-page-text">Time to move off of the notebook</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>